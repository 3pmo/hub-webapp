<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3PMO Hub — Thought Organizer</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-functions-compat.js"></script>
    <!-- Mermaid.js for embedded diagram rendering -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <!-- Chart.js for pairwise analysis charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Google Fonts: JetBrains Mono for data metrics -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;800&display=swap" rel="stylesheet">
    <script>
        mermaid.initialize({
            startOnLoad: false,
            theme: 'base',
            themeVariables: {
                primaryColor: '#1a3a1a',
                primaryTextColor: '#ffffff',
                primaryBorderColor: '#7CC170',
                lineColor: '#7CC170',
                secondaryColor: '#121414',
                tertiaryColor: '#1a1a1e',
                fontFamily: 'Verdana, sans-serif',
                background: '#050606',
                mainBkg: '#121414',
                nodeBorder: '#7CC170',
                clusterBkg: '#121414',
                titleColor: '#ffffff',
                edgeLabelBackground: '#121414'
            }
        });
    </script>
    <style>
        /* AntiGravity Brand System v3.0 — Dark Mission Control */
        :root {
            /* Brand Tokens */
            --ag-bg-black: #050606;
            --ag-card-bg: #121414;
            --ag-surface: #1a1a1e;
            --pmo-green: #7CC170;
            --pmo-grey: #7F8589;
            --ag-lime: #c4ff61;
            --ag-border: rgba(255, 255, 255, 0.08);

            /* Semantic Aliases */
            --bg: var(--ag-bg-black);
            --surface: var(--ag-card-bg);
            --primary: var(--pmo-green);
            --accent: var(--ag-lime);
            --text: #ffffff;
            --text-secondary: #94a3b8;
            --muted: #94a3b8;
            --success: var(--pmo-green);
            --warning: #FF9E1B;
            --error: #e94560;
            --border: var(--ag-border);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Verdana', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
        }

        h1, h2, h3, h4 {
            font-family: 'Verdana', sans-serif;
            font-weight: 700;
        }

        h1 { color: var(--pmo-green); }
        h2, h3, h4 { color: var(--pmo-grey); }

        /* ==========================================
           HUB HEADER BAR
           ========================================== */
        .hub-header {
            background: var(--ag-card-bg);
            padding: 12px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--ag-border);
        }

        .hub-logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .hub-logo-icon {
            width: 36px;
            height: 36px;
            background: rgba(124, 193, 112, 0.15);
            border: 1px solid rgba(124, 193, 112, 0.3);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            color: var(--pmo-green);
            font-weight: bold;
        }

        .hub-logo-text h1 {
            font-size: 1.2rem;
            font-weight: 800;
            letter-spacing: 1px;
            color: var(--text);
            margin: 0;
        }

        .hub-logo-text span {
            font-size: 0.7rem;
            color: var(--pmo-grey);
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .hub-badge {
            background: rgba(124, 193, 112, 0.1);
            border: 1px solid rgba(124, 193, 112, 0.3);
            color: var(--pmo-green);
            padding: 4px 12px;
            border-radius: 99px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        /* ==========================================
           PASSWORD MODAL
           ========================================== */
        .password-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--ag-bg-black);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .password-overlay.hidden { display: none; }

        .password-box {
            background: var(--ag-card-bg);
            padding: 40px;
            border-radius: 16px;
            text-align: center;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            border: 1px solid var(--ag-border);
        }

        .password-box h2 {
            color: var(--pmo-green);
            margin-bottom: 10px;
        }

        .password-box p {
            color: var(--muted);
            margin-bottom: 20px;
        }

        .password-box input {
            width: 100%;
            padding: 12px;
            background: var(--ag-bg-black);
            border: 1px solid var(--ag-border);
            color: var(--text);
            border-radius: 8px;
            font-size: 1rem;
            margin-bottom: 15px;
        }

        .password-box input:focus {
            outline: none;
            border-color: var(--pmo-green);
            box-shadow: 0 0 0 3px rgba(124, 193, 112, 0.2);
        }

        .password-box button {
            width: 100%;
            padding: 12px;
            background: var(--pmo-green);
            color: white;
            border: none;
            border-radius: 99px;
            font-size: 1rem;
            font-family: 'Verdana', sans-serif;
            font-weight: bold;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .password-box button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(124, 193, 112, 0.4);
        }

        .password-box .error {
            color: var(--error);
            margin-top: 10px;
            display: none;
        }

        .app-content { display: none; }
        .app-content.visible { display: block; }

        /* ==========================================
           HUB LAYOUT — SIDEBAR + MAIN
           ========================================== */
        .hub-layout {
            display: grid;
            grid-template-columns: 240px 1fr;
            min-height: calc(100vh - 60px);
        }

        .hub-sidebar {
            background: var(--ag-card-bg);
            border-right: 1px solid var(--ag-border);
            padding: 20px 0;
            display: flex;
            flex-direction: column;
            position: sticky;
            top: 0;
            height: calc(100vh - 60px);
            overflow-y: auto;
        }

        .sidebar-section-label {
            padding: 0 20px 12px;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: var(--pmo-grey);
            font-weight: 600;
        }

        .sidebar-nav {
            display: flex;
            flex-direction: column;
            gap: 4px;
            padding: 0 12px;
            flex: 1;
        }

        .sidebar-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: transparent;
            border: 1px solid transparent;
            border-radius: 12px;
            color: var(--muted);
            cursor: pointer;
            font-family: 'Verdana', sans-serif;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.2s;
            text-align: left;
            width: 100%;
        }

        .sidebar-item:hover {
            color: var(--text);
            background: var(--ag-surface);
            border-color: var(--ag-border);
        }

        .sidebar-item.active {
            color: var(--pmo-green);
            background: rgba(124, 193, 112, 0.1);
            border-color: rgba(124, 193, 112, 0.3);
        }

        .sidebar-icon {
            font-size: 1.2rem;
            width: 24px;
            text-align: center;
            flex-shrink: 0;
        }

        .sidebar-label {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .sidebar-footer {
            padding: 12px 20px;
            border-top: 1px solid var(--ag-border);
            margin-top: auto;
        }

        .sidebar-version {
            font-size: 0.7rem;
            color: var(--pmo-grey);
        }

        .sidebar-toggle {
            display: none;
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 200;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--pmo-green);
            color: white;
            border: none;
            font-size: 1.4rem;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(124, 193, 112, 0.4);
            align-items: center;
            justify-content: center;
        }

        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(5, 6, 6, 0.7);
            z-index: 499;
        }

        .sidebar-overlay.show { display: block; }

        .hub-main {
            padding: 20px 30px;
            overflow-y: auto;
        }

        .storage-notice {
            background: rgba(124, 193, 112, 0.1);
            border: 1px solid rgba(124, 193, 112, 0.3);
            color: var(--pmo-green);
            padding: 8px 15px;
            border-radius: 99px;
            font-size: 0.85rem;
            display: inline-block;
            margin-top: 10px;
        }

        /* ==========================================
           PROJECT PANELS + TABS
           ========================================== */
        .project-panel { display: none; }
        .project-panel.active { display: block; }

        .project-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            padding-bottom: 10px;
        }

        .project-tab {
            padding: 10px 20px;
            background: var(--ag-surface);
            border: 1px solid var(--ag-border);
            color: var(--muted);
            cursor: pointer;
            border-radius: 99px;
            font-size: 1rem;
            font-family: 'Verdana', sans-serif;
            font-weight: 600;
            transition: all 0.2s;
        }

        .project-tab:hover {
            color: var(--text);
            border-color: var(--pmo-green);
        }

        .project-tab.active {
            background: var(--pmo-green);
            color: white;
            border-color: var(--pmo-green);
        }

        .project-tab-content { display: none; }
        .project-tab-content.active { display: block; }

        /* ==========================================
           STATUS DASHBOARD
           ========================================== */
        .status-card {
            background: var(--ag-card-bg);
            border: 1px solid var(--ag-border);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .status-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .status-card-header h3 {
            color: var(--text);
            font-size: 1rem;
            margin: 0;
        }

        .status-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        .status-table th {
            text-align: left;
            padding: 10px 12px;
            color: var(--muted);
            font-weight: 600;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-bottom: 1px solid var(--ag-border);
        }

        .status-table td {
            padding: 10px 12px;
            color: var(--text);
            border-bottom: 1px solid rgba(255, 255, 255, 0.04);
        }

        .status-table tr:hover td {
            background: var(--ag-surface);
        }

        .status-type-badge {
            display: inline-block;
            padding: 2px 10px;
            border-radius: 99px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .status-type-badge.standalone {
            background: rgba(124, 193, 112, 0.15);
            color: var(--pmo-green);
        }

        .status-type-badge.hub-tab {
            background: rgba(196, 255, 97, 0.15);
            color: var(--ag-lime);
        }

        .status-badge {
            display: inline-block;
            padding: 2px 10px;
            border-radius: 99px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .status-badge.active { background: rgba(124, 193, 112, 0.15); color: var(--pmo-green); }
        .status-badge.deployed { background: rgba(196, 255, 97, 0.15); color: var(--ag-lime); }
        .status-badge.archived { background: rgba(127, 133, 137, 0.15); color: var(--pmo-grey); }

        .status-legend {
            margin-top: 20px;
            padding-top: 16px;
            border-top: 1px solid rgba(255, 255, 255, 0.04);
        }

        .status-legend h4 {
            color: var(--muted);
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin: 0 0 12px 0;
        }

        .status-legend dl {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 6px 16px;
            align-items: baseline;
            margin: 0;
        }

        .status-legend dt {
            color: var(--text);
            font-size: 0.8rem;
            font-weight: 600;
            white-space: nowrap;
        }

        .status-legend dd {
            color: var(--muted);
            font-size: 0.78rem;
            line-height: 1.4;
            margin: 0;
        }

        .status-drive-link {
            color: var(--pmo-green);
            text-decoration: none;
            font-size: 0.8rem;
            font-weight: 600;
            opacity: 0.8;
            transition: opacity 0.2s;
        }

        .status-drive-link:hover {
            opacity: 1;
            text-decoration: underline;
        }

        .status-chart-container {
            position: relative;
            height: 280px;
        }

        .status-chart-container.status-chart-wide {
            height: 340px;
        }


        .status-tokens-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .status-gauge-container { padding: 4px 0; }

        .status-gauge {
            width: 100%;
            height: 12px;
            background: var(--ag-surface);
            border-radius: 99px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .status-gauge-fill {
            height: 100%;
            border-radius: 99px;
            background: var(--pmo-green);
            transition: width 0.6s ease, background 0.3s ease;
        }

        .status-gauge-fill.warning { background: var(--warning); }
        .status-gauge-fill.critical { background: var(--error); }

        .status-gauge-labels {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .status-gauge-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text);
        }

        .status-gauge-badge {
            padding: 2px 10px;
            border-radius: 99px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .status-gauge-badge.ok { background: rgba(124, 193, 112, 0.15); color: var(--pmo-green); }
        .status-gauge-badge.warning { background: rgba(255, 158, 27, 0.15); color: var(--warning); }
        .status-gauge-badge.critical { background: rgba(233, 69, 96, 0.15); color: var(--error); }
        .status-gauge-badge.no-data { background: rgba(127, 133, 137, 0.15); color: var(--pmo-grey); }

        .status-gauge-detail {
            display: flex;
            gap: 16px;
            font-size: 0.75rem;
            color: var(--muted);
            font-family: 'JetBrains Mono', monospace;
            margin-bottom: 6px;
        }

        .status-gauge-updated {
            font-size: 0.7rem;
            color: var(--pmo-grey);
        }

        .status-gemini-form {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--ag-border);
        }

        .status-form-row {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
        }

        .status-form-row label {
            font-size: 0.8rem;
            color: var(--muted);
            width: 100px;
            flex-shrink: 0;
        }

        .status-form-row input {
            flex: 1;
            padding: 6px 10px;
            background: var(--ag-surface);
            border: 1px solid var(--ag-border);
            border-radius: 8px;
            color: var(--text);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
        }

        .status-form-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        @media (max-width: 768px) {
            .status-tokens-grid {
                grid-template-columns: 1fr;
            }
        }

        /* ==========================================
           VOICE CAPTURE
           ========================================== */
        .voice-section {
            text-align: center;
            margin-bottom: 30px;
        }

        #voiceBtn {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: 3px solid var(--pmo-green);
            background: var(--ag-card-bg);
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            box-shadow: 0 4px 15px rgba(124, 193, 112, 0.2);
        }

        #voiceBtn:hover {
            background: var(--ag-surface);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(124, 193, 112, 0.4);
        }

        #voiceBtn.listening {
            animation: pulse 1.5s infinite;
            border-color: var(--ag-lime);
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(124, 193, 112, 0.4); }
            50% { box-shadow: 0 0 0 20px rgba(124, 193, 112, 0); }
        }

        #voiceBtn svg {
            width: 50px;
            height: 50px;
            fill: var(--pmo-green);
        }

        #voiceBtn.listening svg { fill: var(--ag-lime); }

        #status {
            font-size: 1.1rem;
            color: var(--muted);
            min-height: 30px;
        }

        /* Transcript */
        #transcript {
            background: var(--ag-card-bg);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            min-height: 80px;
            border: 1px solid var(--ag-border);
            box-shadow: none;
        }

        #transcript.has-text { border-color: var(--pmo-green); }

        #transcriptText {
            font-size: 1.2rem;
            line-height: 1.6;
        }

        /* ==========================================
           FORM SECTION
           ========================================== */
        .form-section {
            background: var(--ag-card-bg);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 20px;
            box-shadow: none;
            border: 1px solid var(--ag-border);
        }

        .form-section h3 {
            margin-bottom: 15px;
            color: var(--pmo-grey);
        }

        .field-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .field {
            display: flex;
            flex-direction: column;
        }

        .field.full-width { grid-column: 1 / -1; }

        .field label {
            font-size: 0.85rem;
            color: var(--muted);
            margin-bottom: 5px;
        }

        .field select,
        .field input,
        .field textarea {
            background: var(--ag-bg-black);
            border: 1px solid var(--ag-border);
            color: var(--text);
            padding: 10px;
            border-radius: 8px;
            font-size: 1rem;
            font-family: 'Verdana', sans-serif;
        }

        .field select {
            cursor: pointer;
            appearance: none;
            -webkit-appearance: none;
            background: var(--ag-bg-black) url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%2394a3b8' d='M6 8L1 3h10z'/%3E%3C/svg%3E") no-repeat right 12px center;
            padding-right: 35px;
        }

        .field select:hover { border-color: var(--pmo-green); }
        .field textarea { min-height: 80px; resize: vertical; }

        .field select:focus,
        .field input:focus,
        .field textarea:focus {
            outline: none;
            border-color: var(--pmo-green);
            box-shadow: 0 0 0 3px rgba(124, 193, 112, 0.2);
        }

        .field select option {
            background: var(--ag-card-bg);
            color: var(--text);
            padding: 10px;
        }

        .field select option:checked {
            background: var(--pmo-green);
            color: white;
        }

        .field input.error,
        .field input:invalid { border-color: var(--error); }

        .field .error-message {
            color: #e94560;
            font-size: 0.8rem;
            margin-top: 5px;
            display: none;
        }

        .field .error-message.show { display: block; }

        /* ==========================================
           SCALE / SLIDER CONTROLS
           ========================================== */
        .slider-container { width: 100%; }

        .slider-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .slider-value {
            font-weight: 800;
            color: var(--ag-lime);
            font-size: 1.1rem;
            font-family: 'JetBrains Mono', monospace;
            min-width: 30px;
            text-align: center;
        }

        .slider-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            color: var(--muted);
            margin-top: 3px;
        }

        .slider-labels span { max-width: 45%; }

        input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: var(--ag-surface);
            outline: none;
            margin: 8px 0;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: var(--pmo-green);
            cursor: pointer;
            border: 2px solid var(--ag-bg-black);
            box-shadow: 0 2px 6px rgba(124, 193, 112, 0.3);
            transition: all 0.2s;
        }

        input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.1);
            background: var(--ag-lime);
        }

        input[type="range"]::-moz-range-thumb {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: var(--pmo-green);
            cursor: pointer;
            border: 2px solid var(--ag-bg-black);
            box-shadow: 0 2px 6px rgba(124, 193, 112, 0.3);
        }

        /* Priority Score Display */
        .priority-display {
            background: var(--ag-surface);
            border: 1px solid var(--ag-border);
            border-radius: 16px;
            padding: 20px;
            margin-top: 15px;
            text-align: center;
            color: var(--text);
        }

        .priority-display > div:first-child {
            font-weight: 600;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .priority-score {
            font-size: 3rem;
            font-weight: 800;
            color: var(--ag-lime);
            font-family: 'JetBrains Mono', monospace;
        }

        .priority-formula {
            font-size: 0.85rem;
            color: var(--muted);
            margin-top: 8px;
            font-family: 'JetBrains Mono', monospace;
        }

        .priority-breakdown {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 10px;
            flex-wrap: wrap;
            color: var(--text-secondary);
        }

        .priority-item { font-size: 0.85rem; }

        .weight-calculation {
            font-size: 0.8rem;
            color: var(--muted);
            font-family: 'JetBrains Mono', monospace;
            background: var(--ag-bg-black);
            padding: 8px 12px;
            border-radius: 8px;
            margin-top: 8px;
            border-left: 3px solid var(--pmo-green);
        }

        .weight-manual { border-left-color: var(--ag-lime); }

        /* ==========================================
           BUTTONS
           ========================================== */
        .actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 99px;
            font-size: 1rem;
            font-family: 'Verdana', sans-serif;
            font-weight: bold;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn-primary { background: var(--pmo-green); color: white; }
        .btn-primary:hover { box-shadow: 0 4px 20px rgba(124, 193, 112, 0.4); }
        .btn-secondary { background: var(--ag-surface); color: var(--pmo-green); border: 1px solid var(--ag-border); }
        .btn-secondary:hover { border-color: var(--pmo-green); box-shadow: 0 4px 20px rgba(124, 193, 112, 0.2); }
        .btn-danger { background: rgba(233, 69, 96, 0.15); color: #e94560; border: 1px solid rgba(233, 69, 96, 0.3); }
        .btn-danger:hover { background: #e94560; color: white; box-shadow: 0 4px 20px rgba(233, 69, 96, 0.3); }
        .btn-success { background: var(--pmo-green); color: white; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .btn-small { padding: 8px 15px; font-size: 0.85rem; }

        /* ==========================================
           REVIEW TAB — TABLE + FILTERS
           ========================================== */
        .filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filters select {
            background: var(--ag-bg-black) url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%2394a3b8' d='M6 8L1 3h10z'/%3E%3C/svg%3E") no-repeat right 12px center;
            border: 1px solid var(--ag-border);
            color: var(--text);
            padding: 8px 35px 8px 15px;
            border-radius: 8px;
            font-family: 'Verdana', sans-serif;
            cursor: pointer;
            appearance: none;
            -webkit-appearance: none;
        }

        .filters select:hover { border-color: var(--pmo-green); }

        .filters select:focus {
            outline: none;
            border-color: var(--pmo-green);
            box-shadow: 0 0 0 3px rgba(124, 193, 112, 0.2);
        }

        .thought-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            background: var(--ag-card-bg);
            box-shadow: none;
            border-radius: 16px;
            overflow: hidden;
            border: 1px solid var(--ag-border);
        }

        .thought-table th,
        .thought-table td {
            padding: 6px 8px;
            text-align: left;
            border-bottom: 1px solid var(--ag-border);
            font-size: 0.9rem;
        }

        .thought-table th {
            background: var(--ag-surface);
            color: var(--pmo-green);
            font-weight: 600;
            cursor: pointer;
            user-select: none;
            position: relative;
            transition: background 0.2s;
        }

        .thought-table th:hover { background: rgba(124, 193, 112, 0.1); }

        .thought-table th.sortable::after { content: ' \2195'; opacity: 0.4; font-size: 0.8em; }
        .thought-table th.sort-asc::after { content: ' \2191'; opacity: 1; }
        .thought-table th.sort-desc::after { content: ' \2193'; opacity: 1; }
        .thought-table th:last-child { cursor: default; }
        .thought-table th:last-child:hover { background: var(--ag-surface); }
        .thought-table tr:hover { background: rgba(124, 193, 112, 0.05); }
        .thought-table tbody tr:nth-child(even) { background: rgba(255, 255, 255, 0.02); }
        .thought-table .actions-cell { white-space: nowrap; }
        .thought-table .actions-cell button { margin-right: 5px; }

        .category-badge {
            padding: 3px 10px;
            border-radius: 99px;
            font-size: 0.8rem;
            background: rgba(124, 193, 112, 0.15);
            color: var(--pmo-green);
            border: 1px solid rgba(124, 193, 112, 0.3);
        }

        /* ==========================================
           STATS GRID
           ========================================== */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: var(--ag-card-bg);
            padding: 20px;
            border-radius: 16px;
            text-align: center;
            box-shadow: none;
            border: 1px solid var(--ag-border);
        }

        .stat-value {
            font-size: 2.25rem;
            font-weight: 800;
            color: var(--ag-lime);
            font-family: 'JetBrains Mono', monospace;
        }

        .stat-label {
            color: var(--muted);
            font-size: 0.9rem;
        }

        /* ==========================================
           MODAL
           ========================================== */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(5,6,6,0.85);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.show { display: flex; }

        .modal-content {
            background: var(--ag-card-bg);
            padding: 30px;
            border-radius: 16px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            border: 1px solid var(--ag-border);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h2 { color: var(--pmo-green); }

        .modal-close {
            background: none;
            border: none;
            color: var(--muted);
            font-size: 1.5rem;
            cursor: pointer;
        }

        .modal-close:hover { color: var(--pmo-green); }

        /* ==========================================
           VISUALIZATIONS
           ========================================== */
        .diagram-container {
            background: var(--ag-bg-black);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            min-height: 200px;
            overflow: auto;
            border: 1px solid var(--ag-border);
        }

        .diagram-container .mermaid { display: flex; justify-content: center; }
        .diagram-container svg { max-width: 100%; height: auto; }

        .diagram-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .diagram-header h3 { margin: 0; color: var(--pmo-grey); }

        .diagram-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .diagram-tab {
            padding: 8px 16px;
            background: var(--ag-surface);
            border: 1px solid var(--ag-border);
            color: var(--muted);
            cursor: pointer;
            border-radius: 99px;
            font-family: 'Verdana', sans-serif;
            font-weight: 600;
            transition: all 0.2s;
        }

        .diagram-tab:hover {
            color: var(--text);
            border-color: var(--pmo-green);
        }

        .diagram-tab.active {
            background: var(--pmo-green);
            color: white;
            border-color: var(--pmo-green);
        }

        .diagram-panel { display: none; }
        .diagram-panel.active { display: block; }

        .mermaid-code {
            display: none;
            background: var(--ag-bg-black);
            color: var(--text-secondary);
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
            font-family: 'JetBrains Mono', 'Consolas', monospace;
            font-size: 0.85rem;
            white-space: pre-wrap;
            max-height: 200px;
            overflow: auto;
        }

        .mermaid-code.show { display: block; }

        /* ==========================================
           TOAST + DATA ACTIONS
           ========================================== */
        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: var(--pmo-green);
            color: white;
            padding: 15px 25px;
            border-radius: 99px;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s;
            z-index: 1001;
            font-weight: 600;
            box-shadow: 0 4px 20px rgba(124, 193, 112, 0.4);
        }

        .toast.show { transform: translateY(0); opacity: 1; }

        .data-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-bottom: 15px;
        }

        /* ==========================================
           FOOTER
           ========================================== */
        footer {
            text-align: center;
            color: var(--muted);
            font-size: 0.85rem;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid var(--ag-border);
        }

        footer a {
            color: var(--pmo-green);
            text-decoration: none;
        }

        footer a:hover { text-decoration: underline; }

        /* ==========================================
           PAIRWISE ANALYSIS
           ========================================== */
        .pw-container { max-width: 800px; margin: 0 auto; }
        .pw-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; }
        .pw-header h2 { color: var(--pmo-green); margin: 0; }
        .pw-saved-controls { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
        .pw-saved-select { padding: 8px 12px; border: 1px solid var(--ag-border); border-radius: 8px; font-family: 'Verdana', sans-serif; font-size: 0.85rem; background: var(--ag-bg-black); color: var(--text); }

        .pw-info-box { background: rgba(124,193,112,0.08); border: 1px solid rgba(124,193,112,0.3); border-radius: 16px; padding: 16px; margin-bottom: 20px; }
        .pw-info-box.warning { background: rgba(255,158,27,0.08); border-color: rgba(255,158,27,0.3); }
        .pw-info-box.danger { background: rgba(233,69,96,0.08); border-color: rgba(233,69,96,0.3); }
        .pw-info-box h3 { margin: 0 0 6px 0; font-size: 0.95rem; }
        .pw-info-box p { margin: 0; font-size: 0.85rem; color: var(--text); }

        .pw-divider { text-align: center; color: var(--muted); font-size: 0.85rem; margin: 20px 0; }

        .pw-mode-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .pw-mode-btn { padding: 16px; border: 1px solid var(--ag-border); border-radius: 16px; cursor: pointer; text-align: center; background: var(--ag-card-bg); transition: all 0.2s; }
        .pw-mode-btn.selected { border-color: var(--pmo-green); background: rgba(124,193,112,0.1); }
        .pw-mode-btn:hover { border-color: var(--pmo-green); }
        .pw-mode-btn .pw-mode-title { font-weight: bold; margin-bottom: 4px; }
        .pw-mode-btn .pw-mode-desc { font-size: 0.8rem; color: var(--muted); }

        .pw-field { margin-bottom: 12px; }
        .pw-field label { display: block; font-size: 0.85rem; font-weight: bold; color: var(--text); margin-bottom: 6px; }
        .pw-field input, .pw-field select { width: 100%; padding: 10px 12px; border: 1px solid var(--ag-border); border-radius: 8px; font-family: 'Verdana', sans-serif; font-size: 0.9rem; box-sizing: border-box; background: var(--ag-bg-black); color: var(--text); }
        .pw-field input:focus { outline: none; border-color: var(--pmo-green); }
        .pw-field-row { display: flex; gap: 8px; align-items: center; margin-bottom: 8px; }
        .pw-field-row input { flex: 1; padding: 10px 12px; border: 1px solid var(--ag-border); border-radius: 8px; font-family: 'Verdana', sans-serif; font-size: 0.9rem; background: var(--ag-bg-black); color: var(--text); }
        .pw-field-row input:focus { outline: none; border-color: var(--pmo-green); }

        .pw-progress-bar { width: 100%; background: var(--border); border-radius: 4px; height: 8px; overflow: hidden; margin: 8px 0; }
        .pw-progress-fill { height: 100%; background: var(--pmo-green); border-radius: 4px; transition: width 0.3s; }

        .pw-member-badges { display: flex; gap: 6px; flex-wrap: wrap; margin-top: 10px; }
        .pw-member-badge { display: inline-block; padding: 4px 12px; border-radius: 15px; font-size: 0.75rem; font-weight: 600; }
        .pw-member-badge.current { background: var(--pmo-green); color: white; }
        .pw-member-badge.done { background: rgba(124,193,112,0.15); color: var(--pmo-green); }
        .pw-member-badge.pending { background: var(--ag-surface); color: var(--muted); }

        .pw-compare-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .pw-option-card { padding: 20px; border-radius: 16px; border: 1px solid var(--ag-border); }
        .pw-option-card.a { background: rgba(124,193,112,0.08); }
        .pw-option-card.b { background: rgba(196,255,97,0.08); }
        .pw-option-card h3 { font-size: 0.85rem; color: var(--muted); margin: 0 0 8px 0; }
        .pw-option-card p { font-size: 1.1rem; font-weight: bold; color: var(--text); margin: 0; }

        .pw-score-section { background: var(--ag-surface); padding: 20px; border-radius: 16px; margin-bottom: 15px; }
        .pw-score-section .pw-score-label { text-align: center; font-weight: 600; color: var(--text); margin-bottom: 12px; }
        .pw-score-hints { display: flex; justify-content: space-between; font-size: 0.75rem; color: var(--muted); margin-bottom: 8px; padding: 0 4px; }
        .pw-score-grid { display: grid; grid-template-columns: repeat(11, 1fr); gap: 6px; }
        .pw-score-btn { padding: 10px 0; border-radius: 8px; font-weight: 600; border: none; cursor: pointer; font-family: 'Verdana', sans-serif; font-size: 0.85rem; transition: all 0.2s; }
        .pw-score-btn.negative { background: rgba(255, 158, 27, 0.2); color: #FF9E1B; }
        .pw-score-btn.negative:hover { background: #FF9E1B; color: var(--ag-bg-black); }
        .pw-score-btn.positive { background: rgba(124, 193, 112, 0.2); color: var(--pmo-green); }
        .pw-score-btn.positive:hover { background: var(--pmo-green); color: white; }
        .pw-score-btn.neutral { background: var(--ag-surface); color: var(--muted); }
        .pw-score-btn.neutral:hover { background: var(--pmo-grey); color: white; }
        .pw-score-hint { text-align: center; font-size: 0.8rem; color: var(--muted); }

        .pw-result-row { display: flex; align-items: center; gap: 15px; padding: 15px; background: var(--ag-card-bg); border-radius: 16px; border: 1px solid var(--ag-border); margin-bottom: 10px; }
        .pw-rank-circle { width: 32px; height: 32px; border-radius: 50%; background: var(--pmo-green); color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0; font-size: 0.9rem; }
        .pw-result-name { flex: 1; font-weight: 600; color: var(--text); }
        .pw-result-name .pw-weight { font-size: 0.75rem; color: var(--muted); font-weight: normal; margin-top: 2px; }
        .pw-result-score { text-align: right; }
        .pw-result-score .pw-score-value { font-size: 1.3rem; font-weight: 800; font-family: 'JetBrains Mono', monospace; }
        .pw-result-score .pw-score-value.positive { color: var(--pmo-green); }
        .pw-result-score .pw-score-value.negative { color: var(--error); }
        .pw-result-score .pw-score-label { font-size: 0.7rem; color: var(--muted); }
        .pw-result-normalized { text-align: right; }
        .pw-result-normalized .pw-norm-value { font-size: 1.1rem; font-weight: 800; color: var(--ag-lime); font-family: 'JetBrains Mono', monospace; }
        .pw-result-normalized .pw-norm-label { font-size: 0.7rem; color: var(--muted); }

        .pw-chart-container { height: 300px; margin-bottom: 20px; }

        .pw-consistency { border-radius: 8px; padding: 16px; margin-bottom: 20px; }
        .pw-consistency.good { background: rgba(124,193,112,0.08); border: 1px solid rgba(124,193,112,0.3); }
        .pw-consistency.warn { background: rgba(255,158,27,0.08); border: 1px solid rgba(255,158,27,0.3); }
        .pw-consistency h3 { margin: 0 0 6px 0; font-size: 0.95rem; }
        .pw-consistency p { margin: 0; font-size: 0.85rem; }

        .pw-inconsistent-item { display: flex; align-items: center; justify-content: space-between; padding: 10px 12px; border-radius: 8px; margin-bottom: 6px; }
        .pw-inconsistent-item.high { background: rgba(233,69,96,0.1); border: 1px solid rgba(233,69,96,0.3); }
        .pw-inconsistent-item.moderate { background: rgba(255,158,27,0.1); border: 1px solid rgba(255,158,27,0.3); }
        .pw-inconsistent-item.low { background: rgba(124,193,112,0.1); border: 1px solid var(--pmo-green); }

        .pw-team-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .pw-team-card { padding: 15px; background: var(--ag-card-bg); border-radius: 16px; border: 1px solid var(--ag-border); }
        .pw-team-card h4 { margin: 0 0 10px 0; color: var(--text); }
        .pw-team-rank { display: flex; justify-content: space-between; font-size: 0.85rem; padding: 4px 0; }

        .pw-actions { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 20px; }

        .pw-section { margin-bottom: 25px; }
        .pw-section h3 { color: var(--text); margin-bottom: 12px; }

        /* ==========================================
           RESPONSIVE
           ========================================== */
        @media (max-width: 768px) {
            .hub-layout {
                grid-template-columns: 1fr;
            }

            .hub-sidebar {
                position: fixed;
                top: 0;
                left: 0;
                width: 280px;
                height: 100vh;
                transform: translateX(-100%);
                transition: transform 0.3s ease;
                z-index: 500;
                padding-top: 70px;
            }

            .hub-sidebar.open {
                transform: translateX(0);
            }

            .sidebar-toggle {
                display: flex;
            }

            .hub-main { padding: 15px; }

            .project-tabs { flex-wrap: wrap; }

            .project-tab {
                padding: 8px 15px;
                font-size: 0.9rem;
            }

            .pw-compare-grid { grid-template-columns: 1fr; }
            .pw-score-grid { grid-template-columns: repeat(11, 1fr); gap: 3px; }
            .pw-score-btn { padding: 8px 0; font-size: 0.75rem; }
            .pw-mode-grid { grid-template-columns: 1fr; }
            .pw-team-grid { grid-template-columns: 1fr; }
            .pw-header { flex-direction: column; align-items: flex-start; }
            .hub-header {
                flex-direction: column;
                gap: 10px;
                padding: 10px 15px;
            }
        }
    </style>
</head>
<body>
    <!-- Firebase Auth Login Overlay -->
    <div class="password-overlay" id="authOverlay">
        <div class="password-box">
            <h2>3PMO Hub</h2>
            <p id="authSubtitle">Sign in to access</p>
            <input type="email" id="authEmail" placeholder="Email" autocomplete="email">
            <input type="password" id="authPassword" placeholder="Password" autocomplete="current-password" onkeypress="if(event.key==='Enter')handleAuth()">
            <button id="authBtn" onclick="handleAuth()">Sign In</button>
            <p class="auth-toggle" id="authToggle" style="margin-top: 12px; font-size: 0.85rem; color: var(--muted); cursor: pointer;" onclick="toggleAuthMode()">Need an account? <span style="color: var(--pmo-green); font-weight: bold;">Sign Up</span></p>
            <p class="error" id="authError" style="display: none;"></p>
        </div>
    </div>

    <!-- Main App Content -->
    <div class="app-content" id="appContent">
        <!-- Hub Header Bar -->
        <div class="hub-header">
            <div class="hub-logo">
                <div class="hub-logo-icon">3P</div>
                <div class="hub-logo-text">
                    <h1><span style="color: var(--pmo-grey);">3</span><span style="color: var(--pmo-green);">PMO</span> Hub</h1>
                    <span>Personal Productivity Hub</span>
                </div>
            </div>
            <div style="display: flex; align-items: center; gap: 12px;">
                <div class="hub-badge">Cloud Synced</div>
                <span id="userEmail" style="color: var(--pmo-grey); font-size: 0.75rem;"></span>
                <button id="signOutBtn" onclick="signOut()" style="background: none; border: 1px solid var(--ag-border); color: var(--muted); padding: 4px 12px; border-radius: 99px; font-size: 0.75rem; cursor: pointer; font-family: 'Verdana', sans-serif; transition: all 0.2s;" onmouseover="this.style.borderColor='var(--pmo-green)';this.style.color='var(--pmo-green)'" onmouseout="this.style.borderColor='rgba(255,255,255,0.08)';this.style.color='#94a3b8'">Sign Out</button>
            </div>
        </div>

        <!-- Hub Layout: Sidebar + Main -->
        <div class="hub-layout">
            <!-- Left Sidebar -->
            <nav class="hub-sidebar" id="hubSidebar">
                <div class="sidebar-section-label">Projects</div>
                <div class="sidebar-nav" id="sidebarNav">
                    <button class="sidebar-item active" data-project="status">
                        <span class="sidebar-icon">&#x1f4ca;</span>
                        <span class="sidebar-label">Status</span>
                    </button>
                    <button class="sidebar-item" data-project="thought-organizer">
                        <span class="sidebar-icon">&#x1f4a1;</span>
                        <span class="sidebar-label">Thought Organizer</span>
                    </button>
                    <button class="sidebar-item" data-project="pairwise">
                        <span class="sidebar-icon">&#x2696;</span>
                        <span class="sidebar-label">Pairwise Analysis</span>
                    </button>
                </div>
                <div class="sidebar-footer">
                    <span class="sidebar-version">v2.0</span>
                </div>
            </nav>
            <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>
            <button class="sidebar-toggle" id="sidebarToggle" onclick="toggleSidebar()">&#9776;</button>

            <!-- Main Content Area -->
            <main class="hub-main" id="hubMain">

                <!-- PROJECT: Status Dashboard -->
                <div class="project-panel active" id="project-status">
                    <div class="project-tabs" data-project="status">
                        <button class="project-tab active" data-tab="projects">Projects</button>
                        <button class="project-tab" data-tab="metrics">Metrics</button>
                        <button class="project-tab" data-tab="tokens">Tokens</button>
                    </div>

                    <!-- TAB: Projects -->
                    <div id="status-projects" class="project-tab-content active">
                        <div class="status-card">
                            <div class="status-card-header">
                                <h3>Active Projects</h3>
                            </div>
                            <table class="status-table">
                                <thead>
                                    <tr>
                                        <th>Project</th>
                                        <th>Type</th>
                                        <th>Status</th>
                                        <th>Parent</th>
                                        <th>Last Active</th>
                                        <th>Drive</th>
                                    </tr>
                                </thead>
                                <tbody id="statusProjectsBody">
                                    <!-- Populated by JS -->
                                </tbody>
                            </table>
                            <div class="status-legend">
                                <h4>Field guide</h4>
                                <dl>
                                    <dt><span class="status-type-badge standalone">Standalone</span></dt>
                                    <dd>Independent project with its own codebase and deployment (e.g. UAE Director, M4P Model)</dd>
                                    <dt><span class="status-type-badge hub-tab">Tab</span></dt>
                                    <dd>Runs inside hub-webapp as a tab — shares the parent's code, hosting, and Firebase project</dd>
                                    <dt><span class="status-badge active">Active</span></dt>
                                    <dd>Currently being worked on — code changes expected</dd>
                                    <dt><span class="status-badge deployed">Deployed</span></dt>
                                    <dd>Live in production and stable — maintenance only, no active feature work</dd>
                                    <dt><span class="status-badge archived">Archived</span></dt>
                                    <dd>Work complete or paused indefinitely — moved to the archive</dd>
                                    <dt>Last Active</dt>
                                    <dd>Date of the most recent AI work session on this project</dd>
                                    <dt>Parent</dt>
                                    <dd>For Tab projects, the parent project whose codebase and deployment they share</dd>
                                    <dt>Drive</dt>
                                    <dd>Link to the project's documentation folder on Google Drive (briefs, research, plans, artifacts)</dd>
                                </dl>
                            </div>
                        </div>
                    </div>

                    <!-- TAB: Metrics -->
                    <div id="status-metrics" class="project-tab-content">
                        <div class="status-card">
                            <div class="status-card-header">
                                <h3>Project Activity Over Time</h3>
                            </div>
                            <div class="status-chart-container status-chart-wide">
                                <canvas id="statusActivityChart"></canvas>
                            </div>
                            <div class="status-legend">
                                <h4>Metric guide</h4>
                                <dl>
                                    <dt><span style="color:#7CC170">&#9632;</span> Sessions</dt>
                                    <dd>Number of AI work sessions conducted on any project that day</dd>
                                    <dt><span style="color:#c4ff61">&#9632;</span> Commits</dt>
                                    <dd>Git commits pushed across all project repositories</dd>
                                    <dt><span style="color:#60a5fa">&#9632;</span> Deploys</dt>
                                    <dd>Production deployments to Firebase Hosting or other platforms</dd>
                                    <dt><span style="color:#7F8589">&#9632;</span> Active Projects</dt>
                                    <dd>Total projects with at least one session that day or recently active (dashed line)</dd>
                                    <dt><span style="color:#FF9E1B">&#9632;</span> Carry-forward</dt>
                                    <dd>Tasks or blockers deferred to the next session — lower is better (dashed line)</dd>
                                </dl>
                            </div>
                        </div>
                    </div>

                    <!-- TAB: Tokens -->
                    <div id="status-tokens" class="project-tab-content">
                        <div class="status-tokens-grid">
                            <div class="status-card status-token-card">
                                <div class="status-card-header">
                                    <h3>Claude (Anthropic)</h3>
                                    <button class="btn btn-secondary btn-small" onclick="statusRefreshClaude()">Refresh</button>
                                </div>
                                <div id="statusClaudeGauge" class="status-gauge-container">
                                    <div class="status-gauge">
                                        <div class="status-gauge-fill" id="statusClaudeFill" style="width: 0%"></div>
                                    </div>
                                    <div class="status-gauge-labels">
                                        <span class="status-gauge-value" id="statusClaudeValue">0.0%</span>
                                        <span class="status-gauge-badge ok" id="statusClaudeBadge">OK</span>
                                    </div>
                                    <div class="status-gauge-detail" id="statusClaudeDetail">
                                        <span>Input: 0</span>
                                        <span>Output: 0</span>
                                        <span>Cost: $0.00</span>
                                    </div>
                                    <div class="status-gauge-detail" id="statusClaudeExtra" style="margin-top: 4px; font-size: 0.7rem; opacity: 0.7;">
                                    </div>
                                    <div class="status-gauge-updated" id="statusClaudeUpdated">Click Refresh to load usage data</div>
                                </div>
                            </div>
                            <div class="status-card status-token-card">
                                <div class="status-card-header">
                                    <h3>Gemini (Google)</h3>
                                    <button class="btn btn-secondary btn-small" onclick="statusShowGeminiForm()">Update</button>
                                </div>
                                <div id="statusGeminiGauge" class="status-gauge-container">
                                    <div class="status-gauge">
                                        <div class="status-gauge-fill" id="statusGeminiFill" style="width: 0%"></div>
                                    </div>
                                    <div class="status-gauge-labels">
                                        <span class="status-gauge-value" id="statusGeminiValue">0.0%</span>
                                        <span class="status-gauge-badge ok" id="statusGeminiBadge">OK</span>
                                    </div>
                                    <div class="status-gauge-detail" id="statusGeminiDetail">
                                        <span>Input: 0</span>
                                        <span>Output: 0</span>
                                    </div>
                                    <div class="status-gauge-updated" id="statusGeminiUpdated">No usage data yet — use Update button to enter manually</div>
                                </div>
                                <!-- Gemini manual entry form (hidden by default) -->
                                <div id="statusGeminiForm" class="status-gemini-form" style="display: none;">
                                    <div class="status-form-row">
                                        <label>Input tokens</label>
                                        <input type="number" id="statusGeminiInput" placeholder="0">
                                    </div>
                                    <div class="status-form-row">
                                        <label>Output tokens</label>
                                        <input type="number" id="statusGeminiOutput" placeholder="0">
                                    </div>
                                    <div class="status-form-row">
                                        <label>Daily limit</label>
                                        <input type="number" id="statusGeminiLimit" placeholder="1500000">
                                    </div>
                                    <div class="status-form-actions">
                                        <button class="btn btn-primary btn-small" onclick="statusSaveGemini()">Save</button>
                                        <button class="btn btn-secondary btn-small" onclick="statusHideGeminiForm()">Cancel</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div> <!-- /project-status -->

                <!-- PROJECT: Thought Organizer -->
                <div class="project-panel" id="project-thought-organizer">
                    <div class="project-tabs" data-project="thought-organizer">
                        <button class="project-tab" data-tab="capture">+ Capture</button>
                        <button class="project-tab active" data-tab="review">Review & Edit</button>
                        <button class="project-tab" data-tab="visualize">Visualize</button>
                    </div>

                    <!-- CAPTURE -->
                    <div id="to-capture" class="project-tab-content">
                    <section class="voice-section">
                        <button id="voiceBtn" title="Click to speak">
                            <svg viewBox="0 0 24 24">
                                <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm-1-9c0-.55.45-1 1-1s1 .45 1 1v6c0 .55-.45 1-1 1s-1-.45-1-1V5zm6 6c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/>
                            </svg>
                        </button>
                        <div id="status">Click the microphone to start speaking</div>
                    </section>

                    <section id="transcript">
                        <div id="transcriptText">Your spoken words will appear here...</div>
                    </section>

                    <section class="form-section">
                        <h3>Organize Your Thought</h3>
                        <div class="field-grid">
                            <div class="field full-width">
                                <label>Name (3-15 chars, must be unique)</label>
                                <input type="text" id="name" placeholder="Short name (max 15)" minlength="3" maxlength="15" required oninput="validateUniqueName()">
                                <div class="error-message" id="nameError">This name already exists. Please use a unique name.</div>
                            </div>

                            <div class="field full-width">
                                <label>Description (optional, max 500 chars)</label>
                                <textarea id="description" placeholder="Add more details..." maxlength="500"></textarea>
                            </div>

                            <div class="field">
                                <label>Category</label>
                                <select id="category">
                                    <option value="Personal" selected>Personal</option>
                                    <option value="Work">Work</option>
                                    <option value="Opportunities">Opportunities</option>
                                    <option value="Family">Family</option>
                                </select>
                            </div>

                            <div class="field">
                                <label>Type</label>
                                <select id="type">
                                    <option value="Task" selected>Task</option>
                                    <option value="Project">Project</option>
                                    <option value="Learning">Learning</option>
                                    <option value="Decision">Decision</option>
                                </select>
                            </div>

                            <div class="field">
                                <label>Due Date (optional)</label>
                                <input type="date" id="dueDate">
                            </div>

                            <div class="field">
                                <label>Status</label>
                                <select id="statusField">
                                    <option value="Idea" selected>Idea</option>
                                    <option value="Started">Started</option>
                                    <option value="Published">Published</option>
                                    <option value="Finished">Finished</option>
                                </select>
                            </div>

                            <!-- Priority Sliders -->
                            <div class="field">
                                <label>Impact</label>
                                <div class="slider-container">
                                    <div class="slider-header">
                                        <span></span>
                                        <span class="slider-value" id="impactValue">5</span>
                                    </div>
                                    <input type="range" id="impact" min="1" max="10" value="5" oninput="updateSlider('impact')">
                                    <div class="slider-labels">
                                        <span>1: Low</span>
                                        <span>10: High</span>
                                    </div>
                                </div>
                            </div>

                            <div class="field">
                                <label>Effort</label>
                                <div class="slider-container">
                                    <div class="slider-header">
                                        <span></span>
                                        <span class="slider-value" id="effortValue">5</span>
                                    </div>
                                    <input type="range" id="effort" min="1" max="10" value="5" oninput="updateSlider('effort')">
                                    <div class="slider-labels">
                                        <span>1: Trivial</span>
                                        <span>10: Very Hard</span>
                                    </div>
                                </div>
                            </div>

                            <div class="field">
                                <label>Urgency</label>
                                <div class="slider-container">
                                    <div class="slider-header">
                                        <span></span>
                                        <span class="slider-value" id="urgencyValue">5</span>
                                    </div>
                                    <input type="range" id="urgency" min="1" max="10" value="5" oninput="updateSlider('urgency')">
                                    <div class="slider-labels">
                                        <span>1: Not Urgent</span>
                                        <span>10: Immediate</span>
                                    </div>
                                </div>
                            </div>

                            <div class="field">
                                <label>Weight <span id="weightAutoLabel" style="font-size: 0.75rem; color: var(--pmo-green);">(auto-calculated)</span> <a href="#" id="weightResetLink" onclick="resetWeightToAuto(); return false;" style="font-size: 0.75rem; display: none;">reset</a></label>
                                <div class="slider-container">
                                    <div class="slider-header">
                                        <span></span>
                                        <span class="slider-value" id="weightValue">5</span>
                                    </div>
                                    <input type="range" id="weight" min="1" max="10" value="5" oninput="updateSlider('weight', true)">
                                    <div class="slider-labels">
                                        <span>1: Less Important</span>
                                        <span>10: More Important</span>
                                    </div>
                                    <div id="weightCalculation" class="weight-calculation">
                                        = round((Impact + (11-Effort) + Urgency) / 3) = round((5 + 6 + 5) / 3) = 5
                                    </div>
                                </div>
                            </div>

                            <!-- Priority Score Display -->
                            <div class="field full-width">
                                <div class="priority-display">
                                    <div>Priority Score</div>
                                    <div class="priority-score" id="priorityScore">5.5</div>
                                    <div class="priority-breakdown" id="priorityBreakdown">
                                        Impact: 5 + Urgency: 5 + (11-Effort): 6 + Weight: 5 = 21
                                    </div>
                                    <div class="priority-formula">
                                        Formula: (Impact + Urgency + (11 - Effort) + Weight) / 4
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>

                    <div class="actions">
                        <button class="btn btn-primary" id="saveBtn">Save Thought</button>
                        <button class="btn btn-secondary" id="clearBtn">Clear</button>
                    </div>
                </div>

                    <!-- REVIEW & EDIT -->
                    <div id="to-review" class="project-tab-content active">
                    <div class="stats-grid" id="statsGrid">
                        <!-- Populated by JS -->
                    </div>

                    <div class="filters" style="justify-content: space-between;">
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <select id="filterCategory">
                                <option value="">All Categories</option>
                                <option value="Personal">Personal</option>
                                <option value="Work">Work</option>
                                <option value="Opportunities">Opportunities</option>
                                <option value="Family">Family</option>
                            </select>
                            <select id="filterStatus">
                                <option value="">All Status</option>
                                <option value="Idea">Idea</option>
                                <option value="Started">Started</option>
                                <option value="Published">Published</option>
                                <option value="Finished">Finished</option>
                            </select>
                            <button class="btn btn-secondary btn-small" id="refreshBtn">Refresh</button>
                        </div>
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <button class="btn btn-secondary btn-small" onclick="exportCSV()">CSV</button>
                            <button class="btn btn-secondary btn-small" onclick="showImportModal()">Import</button>
                            <input type="file" id="importCSVFile" accept=".csv" style="display:none" onchange="handleCSVImport(event)">
                            <button class="btn btn-secondary btn-small" onclick="exportData()">JSON</button>
                            <button class="btn btn-secondary btn-small" onclick="document.getElementById('importFile').click()">Load</button>
                            <input type="file" id="importFile" accept=".json" style="display:none" onchange="importData(event)">
                        </div>
                    </div>

                    <table class="thought-table">
                        <thead>
                            <tr>
                                <th class="sortable" data-sort="name">Name</th>
                                <th class="sortable" data-sort="category">Category</th>
                                <th class="sortable" data-sort="type">Type</th>
                                <th class="sortable" data-sort="priority">Priority</th>
                                <th class="sortable" data-sort="impact">Impact</th>
                                <th class="sortable" data-sort="effort">Effort</th>
                                <th class="sortable" data-sort="urgency">Urgency</th>
                                <th class="sortable" data-sort="dueDate">Due</th>
                                <th class="sortable" data-sort="status">Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="thoughtTableBody">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>

                    <!-- VISUALIZE -->
                    <div id="to-visualize" class="project-tab-content">
                    <div class="diagram-tabs">
                        <button class="diagram-tab active" data-diagram="mindmap">Mind Map</button>
                        <button class="diagram-tab" data-diagram="timeline">Timeline</button>
                        <button class="diagram-tab" data-diagram="gantt">Gantt Chart</button>
                    </div>

                    <!-- Mind Map Panel -->
                    <div id="mindmap-panel" class="diagram-panel active">
                        <div class="form-section">
                            <div class="diagram-header">
                                <h3>Mind Map</h3>
                                <div>
                                    <button class="btn btn-secondary btn-small code-toggle" onclick="toggleCode('mindmap')">Show Code</button>
                                    <button class="btn btn-secondary btn-small" onclick="copyDiagramCode('mindmap')">Copy Code</button>
                                </div>
                            </div>
                            <div class="diagram-container">
                                <div id="mindmap-diagram" class="mermaid"></div>
                            </div>
                            <div id="mindmap-code" class="mermaid-code"></div>
                        </div>
                    </div>

                    <!-- Timeline Panel -->
                    <div id="timeline-panel" class="diagram-panel">
                        <div class="form-section">
                            <div class="diagram-header">
                                <h3>Timeline</h3>
                                <div>
                                    <button class="btn btn-secondary btn-small code-toggle" onclick="toggleCode('timeline')">Show Code</button>
                                    <button class="btn btn-secondary btn-small" onclick="copyDiagramCode('timeline')">Copy Code</button>
                                </div>
                            </div>
                            <div class="diagram-container">
                                <div id="timeline-diagram" class="mermaid"></div>
                            </div>
                            <div id="timeline-code" class="mermaid-code"></div>
                        </div>
                    </div>

                    <!-- Gantt Panel -->
                    <div id="gantt-panel" class="diagram-panel">
                        <div class="form-section">
                            <div class="diagram-header">
                                <h3>Gantt Chart</h3>
                                <div>
                                    <button class="btn btn-secondary btn-small code-toggle" onclick="toggleCode('gantt')">Show Code</button>
                                    <button class="btn btn-secondary btn-small" onclick="copyDiagramCode('gantt')">Copy Code</button>
                                </div>
                            </div>
                            <div class="diagram-container">
                                <div id="gantt-diagram" class="mermaid"></div>
                            </div>
                            <div id="gantt-code" class="mermaid-code"></div>
                        </div>
                    </div>
                </div>

                </div> <!-- /project-thought-organizer -->

                <!-- PROJECT: Pairwise Analysis -->
                <div class="project-panel" id="project-pairwise">
                    <div class="project-tabs" data-project="pairwise">
                        <button class="project-tab active" data-tab="analysis">Analysis</button>
                    </div>

                    <!-- ANALYSIS -->
                    <div id="pw-analysis" class="project-tab-content active">
                        <div class="pw-container">
                            <div class="pw-header">
                                <h2>Pairwise Analysis</h2>
                                <div class="pw-saved-controls">
                                    <select id="pwSavedSelect" class="pw-saved-select">
                                        <option value="">-- Saved Analyses --</option>
                                    </select>
                                    <button class="btn btn-secondary btn-small" onclick="pwLoadSaved()">Load</button>
                                    <button class="btn btn-danger btn-small" onclick="pwDeleteSaved()">Delete</button>
                                </div>
                            </div>
                            <div id="pwApp"></div>
                        </div>
                    </div>
                </div> <!-- /project-pairwise -->

                <footer>
                    <p>3PMO Hub | Personal Productivity Hub</p>
                    <p>Cloud synced via Firebase</p>
                </footer>
            </main>
        </div> <!-- /hub-layout -->
    </div>

    <!-- Edit Modal -->
    <div class="modal" id="editModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Thought</h2>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="field-grid">
                <input type="hidden" id="editId">
                <div class="field full-width">
                    <label>Name (3-15 chars)</label>
                    <input type="text" id="editName" minlength="3" maxlength="15">
                </div>
                <div class="field full-width">
                    <label>Description (max 500 chars)</label>
                    <textarea id="editDescription" maxlength="500"></textarea>
                </div>
                <div class="field">
                    <label>Category</label>
                    <select id="editCategory">
                        <option value="Personal">Personal</option>
                        <option value="Work">Work</option>
                        <option value="Opportunities">Opportunities</option>
                        <option value="Family">Family</option>
                    </select>
                </div>
                <div class="field">
                    <label>Type</label>
                    <select id="editType">
                        <option value="Task">Task</option>
                        <option value="Project">Project</option>
                        <option value="Learning">Learning</option>
                        <option value="Decision">Decision</option>
                    </select>
                </div>
                <div class="field">
                    <label>Status</label>
                    <select id="editStatus">
                        <option value="Idea">Idea</option>
                        <option value="Started">Started</option>
                        <option value="Published">Published</option>
                        <option value="Finished">Finished</option>
                    </select>
                </div>
                <div class="field">
                    <label>Due Date</label>
                    <input type="date" id="editDueDate">
                </div>
                <div class="field">
                    <label>Impact (1-10)</label>
                    <input type="range" id="editImpact" min="1" max="10" value="5">
                    <div class="slider-labels"><span>Low</span><span id="editImpactVal">5</span><span>High</span></div>
                </div>
                <div class="field">
                    <label>Effort (1-10)</label>
                    <input type="range" id="editEffort" min="1" max="10" value="5">
                    <div class="slider-labels"><span>Trivial</span><span id="editEffortVal">5</span><span>Very Hard</span></div>
                </div>
                <div class="field">
                    <label>Urgency (1-10)</label>
                    <input type="range" id="editUrgency" min="1" max="10" value="5">
                    <div class="slider-labels"><span>Not Urgent</span><span id="editUrgencyVal">5</span><span>Immediate</span></div>
                </div>
                <div class="field">
                    <label>Weight (1-10)</label>
                    <input type="range" id="editWeight" min="1" max="10" value="5">
                    <div class="slider-labels"><span>Less Important</span><span id="editWeightVal">5</span><span>More Important</span></div>
                </div>
                <!-- Priority Score Display for Edit -->
                <div class="field full-width">
                    <div class="priority-display">
                        <div>Priority Score</div>
                        <div class="priority-score" id="editPriorityScore">5.5</div>
                        <div class="priority-breakdown" id="editPriorityBreakdown">
                            Impact: 5 + Urgency: 5 + (11-Effort): 6 + Weight: 5 = 21
                        </div>
                        <div class="priority-formula">
                            Formula: (Impact + Urgency + (11 - Effort) + Weight) / 4
                        </div>
                    </div>
                </div>
            </div>
            <div class="actions" style="margin-top: 20px;">
                <button class="btn btn-primary" onclick="saveEdit()">Save Changes</button>
                <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Import Modal -->
    <div class="modal" id="importModal">
        <div class="modal-content" style="max-width: 450px;">
            <div class="modal-header">
                <h2>Import CSV</h2>
                <button class="modal-close" onclick="closeImportModal()">&times;</button>
            </div>
            <div style="margin-bottom: 20px;">
                <p style="margin-bottom: 15px; color: var(--muted);">How should the imported data be handled?</p>
                <div class="field">
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; margin-bottom: 10px;">
                        <input type="radio" name="importMode" value="append" checked style="width: auto;">
                        <span><strong>Append</strong> - Add new items, skip duplicates</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                        <input type="radio" name="importMode" value="replace" style="width: auto;">
                        <span><strong>Replace</strong> - Delete all existing data first</span>
                    </label>
                </div>
            </div>
            <div id="importPreview" style="display: none; margin-bottom: 20px;">
                <p style="font-weight: bold; margin-bottom: 10px;">Preview:</p>
                <div id="importStats" style="background: var(--ag-bg-black); padding: 10px; border-radius: 8px; font-size: 0.9rem;"></div>
            </div>
            <div class="actions" style="margin-top: 20px;">
                <button class="btn btn-primary" onclick="document.getElementById('importCSVFile').click()">Select CSV File</button>
                <button class="btn btn-secondary" onclick="closeImportModal()">Cancel</button>
            </div>
        </div>
    </div>

    <div class="toast" id="toast">Saved!</div>

    <script>
        // ==========================================
        // FIREBASE AUTHENTICATION
        // ==========================================
        let isSignUpMode = false;

        function toggleAuthMode() {
            isSignUpMode = !isSignUpMode;
            const btn = document.getElementById('authBtn');
            const toggle = document.getElementById('authToggle');
            const subtitle = document.getElementById('authSubtitle');
            if (isSignUpMode) {
                btn.textContent = 'Sign Up';
                subtitle.textContent = 'Create your account';
                toggle.innerHTML = 'Already have an account? <span style="color: var(--pmo-green); font-weight: bold;">Sign In</span>';
            } else {
                btn.textContent = 'Sign In';
                subtitle.textContent = 'Sign in to access';
                toggle.innerHTML = 'Need an account? <span style="color: var(--pmo-green); font-weight: bold;">Sign Up</span>';
            }
            document.getElementById('authError').style.display = 'none';
        }

        function showAuthError(msg) {
            const el = document.getElementById('authError');
            el.textContent = msg;
            el.style.display = 'block';
        }

        async function handleAuth() {
            const email = document.getElementById('authEmail').value.trim();
            const password = document.getElementById('authPassword').value;

            if (!email || !password) {
                showAuthError('Email and password required');
                return;
            }

            const btn = document.getElementById('authBtn');
            btn.disabled = true;
            btn.textContent = isSignUpMode ? 'Creating...' : 'Signing in...';
            document.getElementById('authError').style.display = 'none';

            try {
                if (isSignUpMode) {
                    await firebase.auth().createUserWithEmailAndPassword(email, password);
                } else {
                    await firebase.auth().signInWithEmailAndPassword(email, password);
                }
            } catch (e) {
                let msg = 'Authentication failed';
                switch (e.code) {
                    case 'auth/user-not-found': msg = 'No account found with this email'; break;
                    case 'auth/wrong-password': msg = 'Incorrect password'; break;
                    case 'auth/invalid-credential': msg = 'Invalid email or password'; break;
                    case 'auth/email-already-in-use': msg = 'An account with this email already exists'; break;
                    case 'auth/weak-password': msg = 'Password must be at least 6 characters'; break;
                    case 'auth/invalid-email': msg = 'Invalid email address'; break;
                    case 'auth/too-many-requests': msg = 'Too many attempts. Try again later'; break;
                }
                showAuthError(msg);
                btn.disabled = false;
                btn.textContent = isSignUpMode ? 'Sign Up' : 'Sign In';
            }
        }

        function signOut() {
            firebase.auth().signOut();
        }

        function onAuthReady(user) {
            if (user) {
                document.getElementById('authOverlay').classList.add('hidden');
                document.getElementById('appContent').classList.add('visible');
                document.getElementById('userEmail').textContent = user.email;
                initDatabase();
                HubNav.init();
            } else {
                document.getElementById('authOverlay').classList.remove('hidden');
                document.getElementById('appContent').classList.remove('visible');
                document.getElementById('userEmail').textContent = '';
                const btn = document.getElementById('authBtn');
                btn.disabled = false;
                btn.textContent = isSignUpMode ? 'Sign Up' : 'Sign In';
            }
        }

        // ==========================================
        // FIREBASE CONFIGURATION
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyAmop_lDas7esIXMjPlmZRcFk7S1b3JukA",
            authDomain: "thought-organizer-79aff.firebaseapp.com",
            databaseURL: "https://thought-organizer-79aff-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "thought-organizer-79aff",
            storageBucket: "thought-organizer-79aff.firebasestorage.app",
            messagingSenderId: "372144571928",
            appId: "1:372144571928:web:0b2809e88d44b9f0f4256d"
        };

        let db = null;
        let thoughtsRef = null;
        let firebaseReady = false;

        // Initialize Firebase app + auth listener immediately
        try {
            firebase.initializeApp(firebaseConfig);
            firebase.auth().onAuthStateChanged(onAuthReady);
        } catch (e) {
            console.error('Firebase init error:', e);
        }

        function initDatabase() {
            if (firebaseReady) return;
            try {
                db = firebase.database();
                thoughtsRef = db.ref('thoughts');
                firebaseReady = true;
                // Init pairwise analyses ref (per-user)
                const user = firebase.auth().currentUser;
                if (user) {
                    pwAnalysesRef = db.ref('pairwise_analyses/' + user.uid);
                }
                console.log('Firebase Realtime Database initialized');
            } catch (e) {
                console.error('Database init error:', e);
                firebaseReady = false;
            }
        }

        // ==========================================
        // PROJECT REGISTRY
        // ==========================================
        // Each project in the hub is registered here.
        // To add a new project:
        //   1. Add an entry to HUB_PROJECTS
        //   2. Add its HTML panel (class="project-panel" id="project-{id}")
        //   3. Add its tab content panels (class="project-tab-content" id="{prefix}-{tabId}")
        //   4. Add its JS logic (state, functions)
        //   5. Add any project-specific CSS (prefixed with project slug)
        const HUB_PROJECTS = [
            {
                id: 'status',
                name: 'Status',
                icon: '&#x1f4ca;',
                prefix: 'status',
                defaultTab: 'projects',
                tabs: [
                    { id: 'projects', label: 'Projects' },
                    { id: 'metrics', label: 'Metrics' },
                    { id: 'tokens', label: 'Tokens' }
                ],
                onActivate: function() { statusLoad(); }
            },
            {
                id: 'thought-organizer',
                name: 'Thought Organizer',
                icon: '&#x1f4a1;',
                prefix: 'to',
                defaultTab: 'review',
                tabs: [
                    { id: 'capture', label: '+ Capture' },
                    { id: 'review', label: 'Review & Edit' },
                    { id: 'visualize', label: 'Visualize' }
                ],
                onActivate: function() { loadThoughts(); }
            },
            {
                id: 'pairwise',
                name: 'Pairwise Analysis',
                icon: '&#x2696;',
                prefix: 'pw',
                defaultTab: 'analysis',
                tabs: [
                    { id: 'analysis', label: 'Analysis' }
                ],
                onActivate: function() { pwRender(); pwLoadAnalyses(); }
            }
        ];

        // ==========================================
        // HUB NAVIGATION CONTROLLER
        // ==========================================
        const HubNav = {
            activeProjectId: null,

            init: function() {
                // Attach sidebar click handlers
                document.querySelectorAll('.sidebar-item').forEach(btn => {
                    btn.addEventListener('click', () => {
                        HubNav.switchProject(btn.dataset.project);
                        if (window.innerWidth <= 768) toggleSidebar();
                    });
                });

                // Attach project-level tab handlers
                document.querySelectorAll('.project-tabs').forEach(tabBar => {
                    tabBar.querySelectorAll('.project-tab').forEach(tab => {
                        tab.addEventListener('click', () => {
                            HubNav.switchTab(tabBar.dataset.project, tab.dataset.tab);
                        });
                    });
                });

                // Activate default project
                this.switchProject(HUB_PROJECTS[0].id);
            },

            switchProject: function(projectId) {
                const project = HUB_PROJECTS.find(p => p.id === projectId);
                if (!project) return;

                // Update sidebar active state
                document.querySelectorAll('.sidebar-item').forEach(item => {
                    item.classList.toggle('active', item.dataset.project === projectId);
                });

                // Show correct project panel
                document.querySelectorAll('.project-panel').forEach(panel => {
                    panel.classList.toggle('active', panel.id === 'project-' + projectId);
                });

                this.activeProjectId = projectId;

                // Call onActivate
                if (typeof project.onActivate === 'function') project.onActivate();
            },

            switchTab: function(projectId, tabId) {
                const project = HUB_PROJECTS.find(p => p.id === projectId);
                if (!project) return;

                const panel = document.getElementById('project-' + projectId);
                if (!panel) return;

                // Update tab button active state
                panel.querySelectorAll('.project-tab').forEach(t => {
                    t.classList.toggle('active', t.dataset.tab === tabId);
                });

                // Update tab content active state
                const prefix = project.prefix;
                panel.querySelectorAll('.project-tab-content').forEach(c => {
                    c.classList.toggle('active', c.id === prefix + '-' + tabId);
                });

                // Trigger lazy-loads
                if (projectId === 'status') {
                    try {
                        if (!statusRef && firebaseReady && db) statusRef = db.ref('hub_status');
                    } catch (e) { console.error('Status: ref init failed', e); }
                    try {
                        if (tabId === 'projects') statusLoadProjects();
                        if (tabId === 'metrics') statusLoadMetrics();
                        if (tabId === 'tokens') statusLoadTokens();
                    } catch (e) { console.error('Status: tab load failed', e); }
                }
                if (projectId === 'thought-organizer') {
                    if (tabId === 'review') loadThoughts();
                    if (tabId === 'visualize') loadVisualizations();
                }
                if (projectId === 'pairwise') {
                    if (tabId === 'analysis') { pwRender(); pwLoadAnalyses(); }
                }
            }
        };

        function toggleSidebar() {
            document.getElementById('hubSidebar').classList.toggle('open');
            document.getElementById('sidebarOverlay').classList.toggle('show');
        }

        // ==========================================
        // REALTIME DATABASE DATA MANAGEMENT
        // ==========================================
        async function getStoredThoughts() {
            if (!firebaseReady) return [];
            try {
                const snapshot = await thoughtsRef.orderByChild('createdAt').once('value');
                const data = snapshot.val();
                if (!data) return [];
                const thoughts = Object.entries(data).map(([firebaseId, thought]) => {
                    const normalized = {
                        id: thought.id || firebaseId,
                        name: thought.name || thought.title || '',
                        description: thought.description || '',
                        status: thought.status || thought.meta?.status || 'Idea',
                        category: thought.category || 'Personal',
                        type: thought.type || 'Task',
                        dueDate: thought.dueDate || thought.quantitative?.due_date || null,
                        impact: thought.impact || thought.qualitative?.impact || 5,
                        effort: thought.effort || thought.qualitative?.effort || 5,
                        urgency: thought.urgency || thought.qualitative?.urgency || 5,
                        weight: thought.weight || thought.quantitative?.weight || 5,
                        priority: thought.priority || thought.priority_score || null,
                        createdAt: thought.createdAt || thought.meta?.created || new Date().toISOString()
                    };
                    if (!normalized.priority) {
                        normalized.priority = calculatePriority(normalized);
                    }
                    return normalized;
                });
                thoughts.sort((a, b) => (b.createdAt || '').localeCompare(a.createdAt || ''));
                return thoughts;
            } catch (e) {
                console.error('Error fetching thoughts:', e);
                showToast('Error loading data - check console', 'error');
                return [];
            }
        }

        async function saveThought(thought) {
            if (!firebaseReady) return null;
            try {
                const newRef = thoughtsRef.push();
                await newRef.set(thought);
                return newRef.key;
            } catch (e) {
                console.error('Error saving thought:', e);
                showToast('Error saving - check console', 'error');
                return null;
            }
        }

        async function updateThought(id, updates) {
            if (!firebaseReady) return false;
            try {
                const flatUpdates = {};
                for (const [key, value] of Object.entries(updates)) {
                    flatUpdates[key.replace(/\./g, '/')] = value;
                }
                await thoughtsRef.child(id).update(flatUpdates);
                return true;
            } catch (e) {
                console.error('Error updating thought:', e);
                return false;
            }
        }

        async function deleteThoughtFromDb(id) {
            if (!firebaseReady) return false;
            try {
                await thoughtsRef.child(id).remove();
                return true;
            } catch (e) {
                console.error('Error deleting thought:', e);
                return false;
            }
        }

        function generateId() {
            return 'thought-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
        }

        // ==========================================
        // STATE
        // ==========================================
        let impact = 5;
        let effort = 5;
        let urgency = 5;
        let weight = 5;
        let weightManual = false;
        let allThoughts = [];
        let currentSort = { field: 'priority', direction: 'desc' };
        let diagramData = { mindmap: '', timeline: '', gantt: '' };

        // ==========================================
        // SLIDER FUNCTIONS
        // ==========================================
        function updateSlider(name, isManual = false) {
            const slider = document.getElementById(name);
            const valueDisplay = document.getElementById(name + 'Value');
            const value = parseInt(slider.value);
            valueDisplay.textContent = value;

            if (name === 'impact') impact = value;
            if (name === 'effort') effort = value;
            if (name === 'urgency') urgency = value;
            if (name === 'weight') {
                weight = value;
                if (isManual) {
                    weightManual = true;
                    document.getElementById('weightAutoLabel').textContent = '(manual override)';
                    document.getElementById('weightAutoLabel').style.color = 'var(--ag-lime)';
                    document.getElementById('weightCalculation').classList.add('weight-manual');
                    document.getElementById('weightResetLink').style.display = 'inline';
                }
            }

            if (name !== 'weight' && !weightManual) {
                calculateAndSetWeight();
            }

            updateWeightCalculation();
            updatePriorityScore();
        }

        function calculateSuggestedWeight() {
            const effortInverted = 11 - effort;
            const suggested = Math.round((impact + effortInverted + urgency) / 3);
            return Math.min(10, Math.max(1, suggested));
        }

        function calculateAndSetWeight() {
            const suggested = calculateSuggestedWeight();
            weight = suggested;
            document.getElementById('weight').value = suggested;
            document.getElementById('weightValue').textContent = suggested;
        }

        function updateWeightCalculation() {
            const effortInverted = 11 - effort;
            const suggested = calculateSuggestedWeight();
            let calcText = `= round((Impact + (11-Effort) + Urgency) / 3) = round((${impact} + ${effortInverted} + ${urgency}) / 3) = ${suggested}`;
            if (weightManual && weight !== suggested) {
                calcText += ` \u2192 overridden to ${weight}`;
            }
            document.getElementById('weightCalculation').textContent = calcText;
        }

        function resetWeightToAuto() {
            weightManual = false;
            document.getElementById('weightAutoLabel').textContent = '(auto-calculated)';
            document.getElementById('weightAutoLabel').style.color = 'var(--pmo-green)';
            document.getElementById('weightCalculation').classList.remove('weight-manual');
            document.getElementById('weightResetLink').style.display = 'none';
            calculateAndSetWeight();
            updateWeightCalculation();
            updatePriorityScore();
        }

        function updatePriorityScore() {
            const effortInverted = 11 - effort;
            const total = impact + urgency + effortInverted + weight;
            const score = total / 4;
            document.getElementById('priorityScore').textContent = score.toFixed(1);
            document.getElementById('priorityBreakdown').textContent =
                `Impact: ${impact} + Urgency: ${urgency} + (11-Effort): ${effortInverted} + Weight: ${weight} = ${total}`;
        }

        function calculatePriority(t) {
            const i = t.impact || 5;
            const e = t.effort || 5;
            const u = t.urgency || 5;
            const w = t.weight || 5;
            return (i + u + (11 - e) + w) / 4;
        }

        function calculateSuggestedWeightFor(t) {
            const i = t.impact || 5;
            const e = t.effort || 5;
            const u = t.urgency || 5;
            const effortInverted = 11 - e;
            return Math.min(10, Math.max(1, Math.round((i + effortInverted + u) / 3)));
        }

        // ==========================================
        // BULK LOAD FUNCTION
        // ==========================================
        async function bulkLoadThoughts(dataArray) {
            let count = 0;
            for (const item of dataArray) {
                const i = parseInt(item.impact) || 5;
                const e = parseInt(item.effort) || 5;
                const u = parseInt(item.urgency) || 5;
                const w = parseInt(item.weight) || 5;
                const priority = (i + u + (11 - e) + w) / 4;

                const thought = {
                    id: crypto.randomUUID(),
                    name: item.name || item.title || '',
                    description: item.description || '',
                    status: item.status || 'Idea',
                    category: item.category || 'Personal',
                    type: item.type || 'Task',
                    dueDate: item.dueDate || item.due_date || null,
                    impact: i,
                    effort: e,
                    urgency: u,
                    weight: w,
                    priority: priority,
                    createdAt: new Date().toISOString()
                };
                await saveThought(thought);
                count++;
            }
            return count;
        }

        // Tab switching is now handled by HubNav (see PROJECT REGISTRY section)

        // ==========================================
        // SPEECH RECOGNITION
        // ==========================================
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const voiceBtn = document.getElementById('voiceBtn');
        const status = document.getElementById('status');
        const transcriptText = document.getElementById('transcriptText');
        const transcript = document.getElementById('transcript');

        if (!SpeechRecognition) {
            status.textContent = 'Speech not supported. Try Chrome or type manually.';
        } else {
            const recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = true;
            recognition.lang = 'en-US';
            let isListening = false;

            voiceBtn.addEventListener('click', () => {
                if (isListening) recognition.stop();
                else recognition.start();
            });

            recognition.onstart = () => {
                isListening = true;
                voiceBtn.classList.add('listening');
                status.textContent = 'Listening... speak now';
            };

            recognition.onresult = (event) => {
                let final = '', interim = '';
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    if (event.results[i].isFinal) final += event.results[i][0].transcript;
                    else interim += event.results[i][0].transcript;
                }
                transcriptText.textContent = final || interim;
                transcript.classList.add('has-text');
                if (final) parseTranscript(final);
            };

            recognition.onend = () => {
                isListening = false;
                voiceBtn.classList.remove('listening');
                status.textContent = 'Click microphone to speak again';
            };

            recognition.onerror = (e) => {
                isListening = false;
                voiceBtn.classList.remove('listening');
                status.textContent = 'Error: ' + e.error;
            };
        }

        function parseTranscript(text) {
            if (!text || typeof text !== 'string') return;
            try {
                const descEl = document.getElementById('description');
                if (descEl) descEl.value = text.substring(0, 500);

                const lower = text.toLowerCase();

                const words = text.split(/\s+/).filter(w => w.length > 0);
                let suggestedName = words.slice(0, 5).join(' ');
                if (suggestedName && suggestedName.length > 0) {
                    suggestedName = suggestedName.charAt(0).toUpperCase() + suggestedName.slice(1);
                }
                suggestedName = (suggestedName || '').substring(0, 15);
                const nameEl = document.getElementById('name');
                if (nameEl) nameEl.value = suggestedName;

                if (/work|meeting|project|deadline|report|office|client|boss/.test(lower))
                    document.getElementById('category').value = 'Work';
                else if (/family|kids|wife|husband|children|home|parent/.test(lower))
                    document.getElementById('category').value = 'Family';
                else if (/opportunity|career|job|business|money|invest/.test(lower))
                    document.getElementById('category').value = 'Opportunities';
                else if (/learn|health|gym|personal|myself|exercise|read/.test(lower))
                    document.getElementById('category').value = 'Personal';

                if (/decide|decision|choose|choice/.test(lower)) document.getElementById('type').value = 'Decision';
                else if (/learn|study|course|read|research/.test(lower)) document.getElementById('type').value = 'Learning';
                else if (/project|build|create|develop/.test(lower)) document.getElementById('type').value = 'Project';
                else document.getElementById('type').value = 'Task';

                if (/urgent|asap|immediately|critical|emergency/.test(lower)) {
                    document.getElementById('urgency').value = 9;
                    urgency = 9;
                    updateSlider('urgency');
                } else if (/important|soon|priority/.test(lower)) {
                    document.getElementById('urgency').value = 7;
                    urgency = 7;
                    updateSlider('urgency');
                }

                if (/massive|huge|transformative|game.?changer|major/.test(lower)) {
                    document.getElementById('impact').value = 9;
                    impact = 9;
                    updateSlider('impact');
                }

                const dateMatch = text.match(/by (monday|tuesday|wednesday|thursday|friday|saturday|sunday)/i) ||
                                 text.match(/tomorrow/i) || text.match(/next week/i);
                if (dateMatch) {
                    const date = parseDateFromText(text);
                    if (date) document.getElementById('dueDate').value = date;
                }
            } catch (e) {
                console.error('Error parsing transcript:', e);
            }
        }

        function parseDateFromText(text) {
            const lower = text.toLowerCase();
            const today = new Date();

            if (/tomorrow/.test(lower)) {
                today.setDate(today.getDate() + 1);
                return today.toISOString().split('T')[0];
            }
            if (/next week/.test(lower)) {
                today.setDate(today.getDate() + 7);
                return today.toISOString().split('T')[0];
            }

            const days = ['sunday','monday','tuesday','wednesday','thursday','friday','saturday'];
            for (let i = 0; i < days.length; i++) {
                if (lower.includes(days[i])) {
                    let diff = i - today.getDay();
                    if (diff <= 0) diff += 7;
                    today.setDate(today.getDate() + diff);
                    return today.toISOString().split('T')[0];
                }
            }
            return null;
        }

        // ==========================================
        // SAVE NEW THOUGHT
        // ==========================================
        document.getElementById('saveBtn').addEventListener('click', async () => {
            const name = document.getElementById('name').value.trim();
            if (!name) { showToast('Name required', 'error'); return; }
            if (name.length < 3) { showToast('Name must be at least 3 characters', 'error'); return; }
            if (!isNameUnique(name)) { showToast('Name must be unique', 'error'); return; }

            const priority = (impact + urgency + (11 - effort) + weight) / 4;

            const thought = {
                id: crypto.randomUUID(),
                name: name,
                description: document.getElementById('description').value || '',
                status: document.getElementById('statusField').value,
                category: document.getElementById('category').value,
                type: document.getElementById('type').value,
                dueDate: document.getElementById('dueDate').value || null,
                impact: impact,
                effort: effort,
                urgency: urgency,
                weight: weight,
                priority: priority,
                createdAt: new Date().toISOString()
            };

            const id = await saveThought(thought);
            if (id) {
                showToast('Thought saved to cloud!');
                clearForm();
            }
        });

        document.getElementById('clearBtn').addEventListener('click', clearForm);

        function clearForm() {
            ['name', 'description', 'dueDate'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.value = '';
            });
            document.getElementById('category').value = 'Personal';
            document.getElementById('type').value = 'Task';
            document.getElementById('statusField').value = 'Idea';
            transcriptText.textContent = 'Your spoken words will appear here...';
            transcript.classList.remove('has-text');

            ['impact', 'effort', 'urgency', 'weight'].forEach(name => {
                document.getElementById(name).value = 5;
                document.getElementById(name + 'Value').textContent = '5';
            });
            impact = 5; effort = 5; urgency = 5; weight = 5;

            weightManual = false;
            document.getElementById('weightAutoLabel').textContent = '(auto-calculated)';
            document.getElementById('weightAutoLabel').style.color = 'var(--pmo-green)';
            document.getElementById('weightCalculation').classList.remove('weight-manual');
            document.getElementById('weightResetLink').style.display = 'none';
            updateWeightCalculation();
            updatePriorityScore();
        }

        // ==========================================
        // LOAD AND DISPLAY THOUGHTS
        // ==========================================
        async function loadThoughts() {
            allThoughts = await getStoredThoughts();
            renderThoughts();
            renderStats();
        }

        function renderThoughts() {
            const catFilter = document.getElementById('filterCategory').value;
            const statusFilter = document.getElementById('filterStatus').value;

            let filtered = [...allThoughts];
            if (catFilter) filtered = filtered.filter(t => t.category === catFilter);
            if (statusFilter) filtered = filtered.filter(t => t.status === statusFilter);

            if (currentSort.field) {
                filtered.sort((a, b) => {
                    let valA, valB;
                    switch (currentSort.field) {
                        case 'name': valA = (a.name || '').toLowerCase(); valB = (b.name || '').toLowerCase(); break;
                        case 'category': valA = a.category || ''; valB = b.category || ''; break;
                        case 'type': valA = a.type || ''; valB = b.type || ''; break;
                        case 'priority':
                            valA = a.priority || calculatePriority(a);
                            valB = b.priority || calculatePriority(b);
                            break;
                        case 'impact': valA = a.impact || 0; valB = b.impact || 0; break;
                        case 'effort': valA = a.effort || 0; valB = b.effort || 0; break;
                        case 'urgency': valA = a.urgency || 0; valB = b.urgency || 0; break;
                        case 'dueDate':
                            valA = a.dueDate || '9999-12-31';
                            valB = b.dueDate || '9999-12-31';
                            break;
                        case 'status': valA = a.status || ''; valB = b.status || ''; break;
                        default: return 0;
                    }
                    if (valA < valB) return currentSort.direction === 'asc' ? -1 : 1;
                    if (valA > valB) return currentSort.direction === 'asc' ? 1 : -1;
                    return 0;
                });
            }

            const tbody = document.getElementById('thoughtTableBody');
            tbody.innerHTML = filtered.map(t => {
                const priority = t.priority || calculatePriority(t);
                return `
                <tr>
                    <td>${t.name || ''}</td>
                    <td><span class="category-badge">${t.category || ''}</span></td>
                    <td>${t.type || ''}</td>
                    <td><strong>${priority.toFixed(1)}</strong></td>
                    <td>${t.impact || '-'}</td>
                    <td>${t.effort || '-'}</td>
                    <td>${t.urgency || '-'}</td>
                    <td>${t.dueDate || '-'}</td>
                    <td>${t.status || ''}</td>
                    <td class="actions-cell">
                        <button class="btn btn-secondary btn-small" onclick="editThought('${t.id}')">Edit</button>
                        <button class="btn btn-danger btn-small" onclick="deleteThought('${t.id}')">Delete</button>
                    </td>
                </tr>
            `}).join('');

            document.querySelectorAll('.thought-table th.sortable').forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
                if (th.dataset.sort === currentSort.field) {
                    th.classList.add(currentSort.direction === 'asc' ? 'sort-asc' : 'sort-desc');
                }
            });
        }

        // Sortable column headers
        document.querySelectorAll('.thought-table th.sortable').forEach(th => {
            th.addEventListener('click', () => {
                const field = th.dataset.sort;
                if (currentSort.field === field) {
                    currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
                } else {
                    currentSort.field = field;
                    currentSort.direction = 'asc';
                }
                renderThoughts();
            });
        });

        function renderStats() {
            const total = allThoughts.length;
            const highPriority = allThoughts.filter(t => (t.priority || calculatePriority(t)) >= 7).length;
            const active = allThoughts.filter(t => t.status === 'Idea' || t.status === 'Started').length;
            const avgPriority = total > 0 ?
                (allThoughts.reduce((sum, t) => sum + (t.priority || calculatePriority(t)), 0) / total).toFixed(1) : '0.0';

            document.getElementById('statsGrid').innerHTML = `
                <div class="stat-card"><div class="stat-value">${total}</div><div class="stat-label">Total</div></div>
                <div class="stat-card"><div class="stat-value">${highPriority}</div><div class="stat-label">High Priority (7+)</div></div>
                <div class="stat-card"><div class="stat-value">${active}</div><div class="stat-label">Active</div></div>
                <div class="stat-card"><div class="stat-value">${avgPriority}</div><div class="stat-label">Avg Priority</div></div>
            `;
        }

        // Filters
        ['filterCategory', 'filterStatus'].forEach(id =>
            document.getElementById(id).addEventListener('change', renderThoughts));
        document.getElementById('refreshBtn').addEventListener('click', loadThoughts);

        // ==========================================
        // EDIT MODAL
        // ==========================================
        function editThought(id) {
            const t = allThoughts.find(x => x.id === id);
            if (!t) return;

            document.getElementById('editId').value = t.id;
            document.getElementById('editName').value = t.name || '';
            document.getElementById('editDescription').value = t.description || '';
            document.getElementById('editCategory').value = t.category || 'Personal';
            document.getElementById('editType').value = t.type || 'Task';
            document.getElementById('editStatus').value = t.status || 'Idea';
            document.getElementById('editDueDate').value = t.dueDate || '';

            const impactVal = t.impact || 5;
            const effortVal = t.effort || 5;
            const urgencyVal = t.urgency || 5;
            const weightVal = t.weight || 5;

            document.getElementById('editImpact').value = impactVal;
            document.getElementById('editImpactVal').textContent = impactVal;
            document.getElementById('editEffort').value = effortVal;
            document.getElementById('editEffortVal').textContent = effortVal;
            document.getElementById('editUrgency').value = urgencyVal;
            document.getElementById('editUrgencyVal').textContent = urgencyVal;
            document.getElementById('editWeight').value = weightVal;
            document.getElementById('editWeightVal').textContent = weightVal;

            ['editImpact', 'editEffort', 'editUrgency', 'editWeight'].forEach(id => {
                document.getElementById(id).oninput = function() {
                    document.getElementById(id + 'Val').textContent = this.value;
                    updateEditPriorityScore();
                };
            });

            updateEditPriorityScore();
            document.getElementById('editModal').classList.add('show');
        }

        function updateEditPriorityScore() {
            const impact = parseInt(document.getElementById('editImpact').value) || 5;
            const effort = parseInt(document.getElementById('editEffort').value) || 5;
            const urgency = parseInt(document.getElementById('editUrgency').value) || 5;
            const weight = parseInt(document.getElementById('editWeight').value) || 5;

            const effortInverted = 11 - effort;
            const total = impact + urgency + effortInverted + weight;
            const score = total / 4;

            document.getElementById('editPriorityScore').textContent = score.toFixed(1);
            document.getElementById('editPriorityBreakdown').textContent =
                `Impact: ${impact} + Urgency: ${urgency} + (11-Effort): ${effortInverted} + Weight: ${weight} = ${total}`;
        }

        function closeModal() {
            document.getElementById('editModal').classList.remove('show');
        }

        async function saveEdit() {
            const id = document.getElementById('editId').value;

            const i = parseInt(document.getElementById('editImpact').value);
            const e = parseInt(document.getElementById('editEffort').value);
            const u = parseInt(document.getElementById('editUrgency').value);
            const w = parseInt(document.getElementById('editWeight').value);
            const priority = (i + u + (11 - e) + w) / 4;

            const updates = {
                name: document.getElementById('editName').value,
                description: document.getElementById('editDescription').value,
                category: document.getElementById('editCategory').value,
                type: document.getElementById('editType').value,
                status: document.getElementById('editStatus').value,
                dueDate: document.getElementById('editDueDate').value || null,
                impact: i,
                effort: e,
                urgency: u,
                weight: w,
                priority: priority
            };

            const success = await updateThought(id, updates);
            if (success) {
                showToast('Updated!');
                closeModal();
                loadThoughts();
            } else {
                showToast('Update failed', 'error');
            }
        }

        async function deleteThought(id) {
            if (!confirm('Delete this thought?')) return;
            const success = await deleteThoughtFromDb(id);
            if (success) {
                showToast('Deleted');
                loadThoughts();
            } else {
                showToast('Delete failed', 'error');
            }
        }

        // ==========================================
        // EXPORT / IMPORT
        // ==========================================
        async function exportData() {
            const data = await getStoredThoughts();
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'thoughts-backup-' + new Date().toISOString().split('T')[0] + '.json';
            a.click();
            URL.revokeObjectURL(url);
            showToast('Exported!');
        }

        async function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if (Array.isArray(data)) {
                        let count = 0;
                        for (const thought of data) {
                            const { id, ...thoughtData } = thought;
                            await saveThought(thoughtData);
                            count++;
                        }
                        showToast(`Imported ${count} thoughts!`);
                        loadThoughts();
                    } else {
                        showToast('Invalid format', 'error');
                    }
                } catch (err) {
                    showToast('Failed to parse JSON', 'error');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        // ==========================================
        // CSV EXPORT / IMPORT
        // ==========================================
        function exportCSV() {
            if (allThoughts.length === 0) {
                showToast('No data to export', 'error');
                return;
            }

            const headers = ['name', 'description', 'status', 'category', 'type', 'dueDate', 'impact', 'effort', 'urgency', 'weight', 'priority', 'createdAt'];
            const csvRows = [headers.join(',')];

            allThoughts.forEach(t => {
                const row = headers.map(h => {
                    let val = t[h] || '';
                    if (typeof val === 'string' && (val.includes(',') || val.includes('"') || val.includes('\n'))) {
                        val = '"' + val.replace(/"/g, '""') + '"';
                    }
                    return val;
                });
                csvRows.push(row.join(','));
            });

            const csv = csvRows.join('\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'thoughts-' + new Date().toISOString().split('T')[0] + '.csv';
            a.click();
            URL.revokeObjectURL(url);
            showToast('CSV exported!');
        }

        function showImportModal() {
            document.getElementById('importModal').classList.add('show');
            document.getElementById('importPreview').style.display = 'none';
        }

        function closeImportModal() {
            document.getElementById('importModal').classList.remove('show');
        }

        async function handleCSVImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const csv = e.target.result;
                    const rows = parseCSV(csv);

                    if (rows.length < 2) {
                        showToast('CSV must have header row and data', 'error');
                        return;
                    }

                    const headers = rows[0].map(h => h.trim().toLowerCase());
                    const nameIdx = headers.indexOf('name');

                    if (nameIdx === -1) {
                        showToast('CSV must have a "name" column', 'error');
                        return;
                    }

                    const importMode = document.querySelector('input[name="importMode"]:checked').value;
                    const existingNames = new Set(allThoughts.map(t => (t.name || '').toLowerCase()));

                    let imported = 0;
                    let skipped = 0;
                    let duplicates = [];

                    if (importMode === 'replace') {
                        for (const t of allThoughts) {
                            await deleteThoughtFromDb(t.id);
                        }
                        existingNames.clear();
                    }

                    for (let i = 1; i < rows.length; i++) {
                        const row = rows[i];
                        if (row.length === 0 || (row.length === 1 && !row[0])) continue;

                        const name = (row[nameIdx] || '').trim();
                        if (!name || name.length < 3) { skipped++; continue; }

                        if (existingNames.has(name.toLowerCase())) {
                            duplicates.push(name);
                            skipped++;
                            continue;
                        }

                        const thought = {
                            id: crypto.randomUUID(),
                            name: name,
                            description: getCSVValue(headers, row, 'description', ''),
                            status: getCSVValue(headers, row, 'status', 'Idea'),
                            category: getCSVValue(headers, row, 'category', 'Personal'),
                            type: getCSVValue(headers, row, 'type', 'Task'),
                            dueDate: getCSVValue(headers, row, 'duedate', null) || getCSVValue(headers, row, 'due_date', null),
                            impact: parseInt(getCSVValue(headers, row, 'impact', 5)) || 5,
                            effort: parseInt(getCSVValue(headers, row, 'effort', 5)) || 5,
                            urgency: parseInt(getCSVValue(headers, row, 'urgency', 5)) || 5,
                            weight: parseInt(getCSVValue(headers, row, 'weight', 5)) || 5,
                            createdAt: new Date().toISOString()
                        };

                        thought.priority = calculatePriority(thought);

                        await saveThought(thought);
                        existingNames.add(name.toLowerCase());
                        imported++;
                    }

                    closeImportModal();
                    await loadThoughts();

                    let msg = `Imported ${imported} items`;
                    if (skipped > 0) msg += `, skipped ${skipped}`;
                    if (duplicates.length > 0) msg += ` (${duplicates.length} duplicates)`;
                    showToast(msg);

                } catch (err) {
                    console.error('CSV import error:', err);
                    showToast('Failed to parse CSV', 'error');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        function getCSVValue(headers, row, field, defaultValue) {
            const idx = headers.indexOf(field.toLowerCase());
            if (idx === -1 || idx >= row.length) return defaultValue;
            const val = row[idx];
            return val !== undefined && val !== '' ? val : defaultValue;
        }

        function parseCSV(csv) {
            const rows = [];
            let currentRow = [];
            let currentCell = '';
            let inQuotes = false;

            for (let i = 0; i < csv.length; i++) {
                const char = csv[i];
                const nextChar = csv[i + 1];

                if (inQuotes) {
                    if (char === '"' && nextChar === '"') {
                        currentCell += '"';
                        i++;
                    } else if (char === '"') {
                        inQuotes = false;
                    } else {
                        currentCell += char;
                    }
                } else {
                    if (char === '"') {
                        inQuotes = true;
                    } else if (char === ',') {
                        currentRow.push(currentCell.trim());
                        currentCell = '';
                    } else if (char === '\n' || (char === '\r' && nextChar === '\n')) {
                        currentRow.push(currentCell.trim());
                        rows.push(currentRow);
                        currentRow = [];
                        currentCell = '';
                        if (char === '\r') i++;
                    } else if (char !== '\r') {
                        currentCell += char;
                    }
                }
            }

            if (currentCell || currentRow.length > 0) {
                currentRow.push(currentCell.trim());
                rows.push(currentRow);
            }

            return rows;
        }

        // ==========================================
        // UNIQUE NAME VALIDATION
        // ==========================================
        function validateUniqueName(editId = null) {
            const nameInput = document.getElementById('name');
            const errorEl = document.getElementById('nameError');
            const name = nameInput.value.trim().toLowerCase();

            if (!name || name.length < 3) {
                nameInput.classList.remove('error');
                errorEl.classList.remove('show');
                return true;
            }

            const exists = allThoughts.some(t =>
                (t.name || '').toLowerCase() === name && t.id !== editId
            );

            if (exists) {
                nameInput.classList.add('error');
                errorEl.classList.add('show');
                return false;
            } else {
                nameInput.classList.remove('error');
                errorEl.classList.remove('show');
                return true;
            }
        }

        function isNameUnique(name, excludeId = null) {
            const nameLower = (name || '').trim().toLowerCase();
            return !allThoughts.some(t =>
                (t.name || '').toLowerCase() === nameLower && t.id !== excludeId
            );
        }

        // ==========================================
        // DIAGRAM TAB SWITCHING
        // ==========================================
        document.querySelectorAll('.diagram-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.diagram-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.diagram-panel').forEach(p => p.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById(tab.dataset.diagram + '-panel').classList.add('active');
            });
        });

        // ==========================================
        // VISUALIZATIONS — MERMAID DIAGRAMS
        // ==========================================
        function generateMindmap(thoughts) {
            if (thoughts.length === 0) return 'mindmap\n  root((No Thoughts))';

            const sorted = [...thoughts].sort((a, b) => {
                const pA = a.priority || calculatePriority(a);
                const pB = b.priority || calculatePriority(b);
                return pB - pA;
            });

            const top3Ids = new Set(sorted.slice(0, 3).map(t => t.id));

            let code = 'mindmap\n  root((Thoughts))\n';
            const byCategory = {};

            thoughts.forEach(t => {
                if (!byCategory[t.category]) byCategory[t.category] = [];
                byCategory[t.category].push(t);
            });

            for (const cat in byCategory) {
                byCategory[cat].sort((a, b) => {
                    const pA = a.priority || calculatePriority(a);
                    const pB = b.priority || calculatePriority(b);
                    return pB - pA;
                });
                code += `    ${cat}\n`;
                byCategory[cat].forEach(t => {
                    const safeName = (t.name || '').replace(/[()[\]{}:]/g, '').substring(0, 15);
                    const priority = t.priority || calculatePriority(t);
                    const score = priority.toFixed(1);

                    if (top3Ids.has(t.id)) {
                        code += `      ((${safeName} ${score}))\n`;
                    } else if (priority >= 7) {
                        code += `      (${safeName} ${score})\n`;
                    } else if (priority >= 5) {
                        code += `      [${safeName} ${score}]\n`;
                    } else {
                        code += `      ${safeName} ${score}\n`;
                    }
                });
            }
            return code;
        }

        function generateTimeline(thoughts) {
            const withDates = thoughts.filter(t => t.dueDate);
            if (withDates.length === 0) return 'timeline\n    title No items with due dates';

            let code = 'timeline\n    title Task Timeline\n';
            withDates.sort((a, b) => (a.dueDate || '').localeCompare(b.dueDate || ''));

            withDates.forEach(t => {
                const safeName = (t.name || '').replace(/:/g, '-').substring(0, 25);
                code += `    ${t.dueDate} : ${safeName}\n`;
            });
            return code;
        }

        function generateGantt(thoughts) {
            const withDates = thoughts.filter(t => t.dueDate);
            if (withDates.length === 0) return 'gantt\n    title No Tasks\n    dateFormat YYYY-MM-DD\n    section Empty\n    No tasks : 2024-01-01, 1d';

            let code = 'gantt\n    title Task Schedule\n    dateFormat YYYY-MM-DD\n';

            const byCategory = {};
            withDates.forEach(t => {
                if (!byCategory[t.category]) byCategory[t.category] = [];
                byCategory[t.category].push(t);
            });

            for (const cat in byCategory) {
                code += `    section ${cat}\n`;
                byCategory[cat].forEach(t => {
                    const safeName = (t.name || '').replace(/:/g, '-').substring(0, 20);
                    const days = Math.max(1, Math.ceil((t.effort || 5) / 2));
                    code += `    ${safeName} : ${t.dueDate}, ${days}d\n`;
                });
            }
            return code;
        }

        async function loadVisualizations() {
            const thoughts = await getStoredThoughts();

            diagramData.mindmap = generateMindmap(thoughts);
            diagramData.timeline = generateTimeline(thoughts);
            diagramData.gantt = generateGantt(thoughts);

            document.getElementById('mindmap-code').textContent = diagramData.mindmap;
            document.getElementById('timeline-code').textContent = diagramData.timeline;
            document.getElementById('gantt-code').textContent = diagramData.gantt;

            await renderDiagram('mindmap', diagramData.mindmap);
            await renderDiagram('timeline', diagramData.timeline);
            await renderDiagram('gantt', diagramData.gantt);
        }

        async function renderDiagram(type, code) {
            const container = document.getElementById(type + '-diagram');
            try {
                container.innerHTML = '';
                const id = 'mermaid-' + type + '-' + Date.now();
                const { svg } = await mermaid.render(id, code);
                container.innerHTML = svg;
            } catch (e) {
                console.error('Mermaid render error for ' + type + ':', e);
                container.innerHTML = `<div style="color: var(--warning); padding: 20px;">
                    <p>Unable to render ${type} diagram.</p>
                    <p style="font-size: 0.85rem; color: var(--muted);">Click "Show Code" to view the Mermaid code.</p>
                </div>`;
            }
        }

        function toggleCode(type) {
            const codeEl = document.getElementById(type + '-code');
            codeEl.classList.toggle('show');
            const btn = event.target;
            btn.textContent = codeEl.classList.contains('show') ? 'Hide Code' : 'Show Code';
        }

        function copyDiagramCode(type) {
            const code = diagramData[type];
            navigator.clipboard.writeText(code).then(() => {
                showToast('Code copied to clipboard!');
            }).catch(() => {
                const textarea = document.createElement('textarea');
                textarea.value = code;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                showToast('Code copied to clipboard!');
            });
        }

        // ==========================================
        // TOAST
        // ==========================================
        function showToast(msg, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.style.background = type === 'error' ? '#e94560' : 'var(--pmo-green)';
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        // ==========================================
        // STATUS DASHBOARD
        // ==========================================
        let statusRef = null;
        let statusActivityChart = null;

        // Seed data matching current project registry
        const STATUS_SEED_PROJECTS = {
            'uae-director': { name: 'UAE Director', type: 'standalone', status: 'Active', parent: null, lastActive: '2026-02-08', drive: 'F:\\My Drive\\AI\\Projects\\uae-director' },
            'hub-webapp': { name: 'Hub Webapp', type: 'standalone', status: 'Deployed', parent: null, lastActive: '2026-02-10', drive: 'F:\\My Drive\\AI\\Projects\\hub-webapp' },
            'thought': { name: 'Thought Organizer', type: 'hub-tab', status: 'Active', parent: 'hub-webapp', lastActive: '2026-02-09', drive: 'F:\\My Drive\\AI\\Projects\\thought' },
            'pairwise': { name: 'Pairwise Analysis', type: 'hub-tab', status: 'Active', parent: 'hub-webapp', lastActive: '2026-02-08', drive: 'F:\\My Drive\\AI\\Projects\\pairwise' },
            'status': { name: 'Status Dashboard', type: 'hub-tab', status: 'Active', parent: 'hub-webapp', lastActive: '2026-02-10', drive: 'F:\\My Drive\\AI\\Projects\\status' },
            'm4p-model': { name: 'M4P Model', type: 'standalone', status: 'Active', parent: null, lastActive: '2026-02-08', drive: 'F:\\My Drive\\AI\\Projects\\m4p-model' }
        };

        const STATUS_SEED_METRICS = {
            activity: {
                '2026-02-06': { sessions: 1, commits: 3, deploys: 1, activeProjects: 2, carryForward: 0 },
                '2026-02-07': { sessions: 0, commits: 0, deploys: 0, activeProjects: 2, carryForward: 0 },
                '2026-02-08': { sessions: 4, commits: 7, deploys: 3, activeProjects: 5, carryForward: 3 },
                '2026-02-09': { sessions: 3, commits: 4, deploys: 2, activeProjects: 6, carryForward: 5 }
            }
        };

        const STATUS_SEED_TOKENS = {
            claude: {
                input_tokens: 0,
                output_tokens: 0,
                estimated_cost_cents: 0,
                sessions: 0,
                lines_added: 0,
                lines_removed: 0,
                commits: 0,
                date: null,
                limits: { daily_input: 700000, daily_output: 300000 },
                last_updated: null
            },
            gemini: {
                input_tokens: 0,
                output_tokens: 0,
                limits: { daily_input: 1050000, daily_output: 450000 },
                last_updated: Date.now()
            }
        };

        function statusLoad() {
            if (firebaseReady && !statusRef) {
                statusRef = db.ref('hub_status');
            }
            // Load only the active tab's data (default: projects)
            const activeTab = document.querySelector('#project-status .project-tab.active');
            const tabId = activeTab ? activeTab.dataset.tab : 'projects';
            if (tabId === 'projects') statusLoadProjects();
            else if (tabId === 'metrics') statusLoadMetrics();
            else if (tabId === 'tokens') statusLoadTokens();
        }

        // --- PROJECT TABLE ---
        async function statusLoadProjects() {
            if (!statusRef) { statusRenderProjects(STATUS_SEED_PROJECTS); return; }
            try {
                const snap = await statusRef.child('projects').once('value');
                let data = snap.val();
                if (!data) {
                    await statusRef.child('projects').set(STATUS_SEED_PROJECTS);
                    data = STATUS_SEED_PROJECTS;
                }
                statusRenderProjects(data);
            } catch (e) {
                console.error('Status: failed to load projects', e);
                statusRenderProjects(STATUS_SEED_PROJECTS);
            }
        }

        function statusRenderProjects(data) {
            const tbody = document.getElementById('statusProjectsBody');
            if (!tbody) return;
            const esc = s => s ? s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;') : '';
            const rows = Object.entries(data).map(([id, p]) => {
                const typeClass = p.type === 'hub-tab' ? 'hub-tab' : 'standalone';
                const statusClass = (p.status || 'Active').toLowerCase();
                const drivePath = p.drive || ('F:\\My Drive\\AI\\Projects\\' + id);
                return `<tr>
                    <td><strong>${esc(p.name)}</strong></td>
                    <td><span class="status-type-badge ${typeClass}">${p.type === 'hub-tab' ? 'Tab' : 'Standalone'}</span></td>
                    <td><span class="status-badge ${statusClass}">${esc(p.status) || 'Active'}</span></td>
                    <td>${esc(p.parent) || '—'}</td>
                    <td>${esc(p.lastActive) || '—'}</td>
                    <td><a href="file:///${drivePath.replace(/\\/g, '/')}" class="status-drive-link" title="${esc(drivePath)}">Open</a></td>
                </tr>`;
            }).join('');
            tbody.innerHTML = rows;
        }

        // --- PERFORMANCE METRICS ---
        async function statusLoadMetrics() {
            if (!statusRef) { statusRenderCharts(STATUS_SEED_METRICS); return; }
            try {
                const snap = await statusRef.child('metrics').once('value');
                let data = snap.val();
                if (!data || !data.activity) {
                    // No data or old format (sessions/health) — overwrite with new structure
                    await statusRef.child('metrics').set(STATUS_SEED_METRICS).catch(() => {});
                    data = STATUS_SEED_METRICS;
                }
                statusRenderCharts(data);
            } catch (e) {
                console.error('Status: failed to load metrics', e);
                statusRenderCharts(STATUS_SEED_METRICS);
            }
        }

        function statusRenderCharts(data) {
            const canvas = document.getElementById('statusActivityChart');
            if (!canvas || !data.activity) return;
            if (statusActivityChart) statusActivityChart.destroy();

            const dates = Object.keys(data.activity).sort();
            const labels = dates.map(d => d.substring(5)); // MM-DD

            const datasets = [
                {
                    label: 'Sessions',
                    data: dates.map(d => data.activity[d].sessions || 0),
                    borderColor: '#7CC170',
                    backgroundColor: 'rgba(124, 193, 112, 0.1)',
                    pointBackgroundColor: '#7CC170',
                    tension: 0.3,
                    fill: false
                },
                {
                    label: 'Commits',
                    data: dates.map(d => data.activity[d].commits || 0),
                    borderColor: '#c4ff61',
                    backgroundColor: 'rgba(196, 255, 97, 0.1)',
                    pointBackgroundColor: '#c4ff61',
                    tension: 0.3,
                    fill: false
                },
                {
                    label: 'Deploys',
                    data: dates.map(d => data.activity[d].deploys || 0),
                    borderColor: '#60a5fa',
                    backgroundColor: 'rgba(96, 165, 250, 0.1)',
                    pointBackgroundColor: '#60a5fa',
                    tension: 0.3,
                    fill: false
                },
                {
                    label: 'Active Projects',
                    data: dates.map(d => data.activity[d].activeProjects || 0),
                    borderColor: '#7F8589',
                    backgroundColor: 'rgba(127, 133, 137, 0.1)',
                    pointBackgroundColor: '#7F8589',
                    borderDash: [5, 3],
                    tension: 0.3,
                    fill: false
                },
                {
                    label: 'Carry-forward',
                    data: dates.map(d => data.activity[d].carryForward || 0),
                    borderColor: '#FF9E1B',
                    backgroundColor: 'rgba(255, 158, 27, 0.1)',
                    pointBackgroundColor: '#FF9E1B',
                    borderDash: [2, 2],
                    tension: 0.3,
                    fill: false
                }
            ];

            statusActivityChart = new Chart(canvas, {
                type: 'line',
                data: { labels, datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: '#94a3b8', padding: 14, usePointStyle: true, font: { size: 11 } }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(18, 20, 20, 0.95)',
                            titleColor: '#e2e8f0',
                            bodyColor: '#94a3b8',
                            borderColor: 'rgba(255,255,255,0.08)',
                            borderWidth: 1
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#94a3b8' },
                            grid: { color: 'rgba(255,255,255,0.04)' }
                        },
                        y: {
                            beginAtZero: true,
                            ticks: { color: '#94a3b8', stepSize: 1 },
                            grid: { color: 'rgba(255,255,255,0.04)' }
                        }
                    }
                }
            });
        }

        // --- TOKEN USAGE ---
        async function statusLoadTokens() {
            // Always render seed data immediately (synchronous, guaranteed)
            statusRenderTokenGauge('Claude', STATUS_SEED_TOKENS.claude, 'statusClaude');
            statusRenderTokenGauge('Gemini', STATUS_SEED_TOKENS.gemini, 'statusGemini');

            // Then try Firebase for real data (async upgrade)
            if (!statusRef) return;
            try {
                const snap = await statusRef.child('token_usage').once('value');
                const data = snap.val();
                if (data) {
                    if (data.claude && data.claude.limits) {
                        statusRenderTokenGauge('Claude', data.claude, 'statusClaude');
                    }
                    if (data.gemini && data.gemini.limits) {
                        statusRenderTokenGauge('Gemini', data.gemini, 'statusGemini');
                    }
                }
            } catch (e) {
                // Seed already rendered — nothing to do
                console.error('Status: token Firebase read failed', e);
            }
        }

        function statusRenderTokenGauge(provider, data, idPrefix) {
            try {
                const fill = document.getElementById(idPrefix + 'Fill');
                const value = document.getElementById(idPrefix + 'Value');
                const badge = document.getElementById(idPrefix + 'Badge');
                const detail = document.getElementById(idPrefix + 'Detail');
                const updated = document.getElementById(idPrefix + 'Updated');
                const extra = document.getElementById(idPrefix + 'Extra');
                if (!fill || !value || !badge) { console.warn('Token gauge elements not found:', idPrefix); return; }

                if (!data || !data.limits) {
                    value.textContent = '0.0%';
                    badge.textContent = 'OK';
                    badge.className = 'status-gauge-badge ok';
                    fill.style.width = '0%';
                    if (detail) detail.innerHTML = '<span>Input: 0</span><span>Output: 0</span>';
                    return;
                }

                const totalUsed = (Number(data.input_tokens) || 0) + (Number(data.output_tokens) || 0);
                const totalLimit = (Number(data.limits.daily_input) || 0) + (Number(data.limits.daily_output) || 0);
                const pct = totalLimit > 0 ? Math.min((totalUsed / totalLimit) * 100, 100) : 0;

                fill.style.width = pct.toFixed(1) + '%';
                fill.className = 'status-gauge-fill' + (pct > 80 ? ' critical' : pct > 60 ? ' warning' : '');

                value.textContent = pct.toFixed(1) + '%';

                const riskLevel = pct > 80 ? 'Critical' : pct > 60 ? 'Warning' : 'OK';
                badge.textContent = riskLevel;
                badge.className = 'status-gauge-badge ' + riskLevel.toLowerCase();

                const fmt = n => { n = Number(n) || 0; return n >= 1000000 ? (n / 1000000).toFixed(1) + 'M' : n >= 1000 ? (n / 1000).toFixed(0) + 'K' : String(n); };
                let detailHtml = '<span>Input: ' + fmt(data.input_tokens) + '</span><span>Output: ' + fmt(data.output_tokens) + '</span>';

                // Cost: handle both cents (new API) and dollar (old format)
                if (data.estimated_cost_cents != null && Number(data.estimated_cost_cents) > 0) {
                    detailHtml += '<span>Cost: $' + (Number(data.estimated_cost_cents) / 100).toFixed(2) + '</span>';
                } else if (data.total_cost != null && !isNaN(data.total_cost)) {
                    detailHtml += '<span>Cost: $' + Number(data.total_cost).toFixed(2) + '</span>';
                }
                if (detail) detail.innerHTML = detailHtml;

                // Extra metrics row (Claude Code Analytics: sessions, LOC, commits)
                if (extra && provider === 'Claude') {
                    let extraHtml = '';
                    if (data.sessions != null && Number(data.sessions) > 0) {
                        extraHtml += '<span>Sessions: ' + data.sessions + '</span>';
                    }
                    if ((data.lines_added || 0) > 0 || (data.lines_removed || 0) > 0) {
                        extraHtml += '<span>LOC: +' + (data.lines_added || 0) + ' / -' + (data.lines_removed || 0) + '</span>';
                    }
                    if ((data.commits || 0) > 0) {
                        extraHtml += '<span>Commits: ' + data.commits + '</span>';
                    }
                    if (data.date) {
                        extraHtml += '<span>Date: ' + data.date + '</span>';
                    }
                    extra.innerHTML = extraHtml;
                }

                if (updated && data.last_updated) {
                    updated.textContent = 'Last updated: ' + new Date(data.last_updated).toLocaleString();
                }
            } catch (e) {
                console.error('Token gauge render error (' + provider + '):', e);
            }
        }

        async function statusRefreshClaude() {
            try {
                const btn = document.querySelector('#project-status .status-token-card:first-child .btn');
                if (btn) { btn.disabled = true; btn.textContent = 'Loading...'; }

                const fetchUsage = firebase.functions().httpsCallable('fetchClaudeUsage');
                const result = await fetchUsage();

                if (result.data && result.data.success) {
                    statusRenderTokenGauge('Claude', result.data.data, 'statusClaude');
                    showToast('Claude usage refreshed');
                } else {
                    showToast('Refresh returned no data — check Cloud Function logs');
                }
            } catch (e) {
                console.error('Claude refresh failed:', e);
                if (e.code === 'functions/not-found' || e.message?.includes('not-found')) {
                    showToast('Cloud Function not deployed yet — upgrade to Blaze plan first');
                } else {
                    showToast('Refresh failed: ' + (e.message || 'Unknown error'));
                }
            } finally {
                const btn = document.querySelector('#project-status .status-token-card:first-child .btn');
                if (btn) { btn.disabled = false; btn.textContent = 'Refresh'; }
            }
        }

        function statusShowGeminiForm() {
            document.getElementById('statusGeminiForm').style.display = 'block';
        }

        function statusHideGeminiForm() {
            document.getElementById('statusGeminiForm').style.display = 'none';
        }

        async function statusSaveGemini() {
            if (!statusRef) return;
            const input = parseInt(document.getElementById('statusGeminiInput').value) || 0;
            const output = parseInt(document.getElementById('statusGeminiOutput').value) || 0;
            const limit = parseInt(document.getElementById('statusGeminiLimit').value) || 1500000;
            await statusRef.child('token_usage/gemini').set({
                input_tokens: input,
                output_tokens: output,
                limits: { daily_input: Math.floor(limit * 0.7), daily_output: Math.floor(limit * 0.3) },
                last_updated: Date.now()
            });
            statusHideGeminiForm();
            statusLoadTokens();
            showToast('Gemini usage updated');
        }

        // Make functions available globally for onclick handlers
        window.handleAuth = handleAuth;
        window.toggleAuthMode = toggleAuthMode;
        window.signOut = signOut;
        window.deleteThought = deleteThought;
        window.editThought = editThought;
        window.exportData = exportData;
        window.exportCSV = exportCSV;
        window.showImportModal = showImportModal;
        window.closeImportModal = closeImportModal;
        window.toggleCode = toggleCode;
        window.copyDiagramCode = copyDiagramCode;
        window.toggleSidebar = toggleSidebar;
        window.HubNav = HubNav;
        window.statusLoad = statusLoad;
        window.statusLoadTokens = statusLoadTokens;
        window.statusRefreshClaude = statusRefreshClaude;
        window.statusShowGeminiForm = statusShowGeminiForm;
        window.statusHideGeminiForm = statusHideGeminiForm;
        window.statusSaveGemini = statusSaveGemini;

        // ==========================================
        // PAIRWISE ANALYSIS MODULE
        // ==========================================
        const pwState = {
            step: 'setup',
            mode: 'personal',
            options: ['', '', '', '', ''],
            teamMembers: [{ name: '', scores: {} }],
            currentPair: 0,
            currentMember: 0,
            analysisName: '',
            analysisId: null
        };

        let pwAnalysesRef = null;
        let pwChartInstance = null;

        // --- Utility functions ---

        function pwConvertToAHP(score) {
            const mapping = {
                '-5': 1/9, '-4': 1/7, '-3': 1/5, '-2': 1/3, '-1': 1/2,
                '0': 1,
                '1': 2, '2': 3, '3': 5, '4': 7, '5': 9
            };
            return mapping[score.toString()] || 1;
        }

        function pwGetValidOptions() {
            return pwState.options.filter(opt => opt.trim() !== '');
        }

        function pwGetPairs() {
            const validOptions = pwGetValidOptions();
            const pairs = [];
            for (let i = 0; i < validOptions.length; i++) {
                for (let j = i + 1; j < validOptions.length; j++) {
                    pairs.push([i, j]);
                }
            }
            return pairs;
        }

        function pwGetAggregateScores() {
            if (pwState.mode === 'personal') return pwState.teamMembers[0].scores;
            const aggregated = {};
            const pairs = pwGetPairs();
            pairs.forEach(([i, j]) => {
                const key = `${i}-${j}`;
                const scores = pwState.teamMembers
                    .filter(m => m.scores[key] !== undefined)
                    .map(m => m.scores[key]);
                if (scores.length > 0) {
                    aggregated[key] = Math.round(scores.reduce((sum, s) => sum + s, 0) / scores.length);
                }
            });
            return aggregated;
        }

        // --- Calculation functions ---

        function pwCalculateResults() {
            const validOptions = pwGetValidOptions();
            const scores = pwGetAggregateScores();
            const totals = {};
            validOptions.forEach(opt => { totals[opt] = 0; });

            Object.entries(scores).forEach(([key, score]) => {
                const [i, j] = key.split('-').map(Number);
                totals[validOptions[i]] += score;
                totals[validOptions[j]] -= score;
            });

            const results = Object.entries(totals)
                .map(([option, score]) => ({ option, score }))
                .sort((a, b) => b.score - a.score);

            const minScore = Math.min(...results.map(r => r.score));
            const maxScore = Math.max(...results.map(r => r.score));
            const range = maxScore - minScore;

            results.forEach(result => {
                result.weight = range === 0 ? 1 / results.length : (result.score - minScore) / range;
            });

            const weightSum = results.reduce((sum, r) => sum + r.weight, 0);
            results.forEach(result => {
                result.normalizedWeight = weightSum > 0 ? result.weight / weightSum : 1 / results.length;
            });

            return results;
        }

        function pwCalculateConsistency() {
            const validOptions = pwGetValidOptions();
            const scores = pwGetAggregateScores();
            const n = validOptions.length;
            if (n < 3) return { ratio: 0, isConsistent: true };

            const matrix = Array(n).fill(0).map(() => Array(n).fill(1));
            Object.entries(scores).forEach(([key, score]) => {
                const [i, j] = key.split('-').map(Number);
                const ahpValue = pwConvertToAHP(score);
                matrix[i][j] = ahpValue;
                matrix[j][i] = 1 / ahpValue;
            });

            const colSums = Array(n).fill(0);
            for (let j = 0; j < n; j++) {
                for (let i = 0; i < n; i++) {
                    colSums[j] += matrix[i][j];
                }
            }

            const normalized = matrix.map((row) => row.map((val, j) => val / colSums[j]));
            const priorities = normalized.map(row => row.reduce((sum, val) => sum + val, 0) / n);

            let lambdaMax = 0;
            for (let j = 0; j < n; j++) {
                let sum = 0;
                for (let i = 0; i < n; i++) {
                    sum += matrix[i][j] * priorities[i];
                }
                lambdaMax += sum / priorities[j];
            }
            lambdaMax /= n;

            const CI = (lambdaMax - n) / (n - 1);
            const RI = [0, 0, 0.58, 0.90, 1.12, 1.24, 1.32, 1.41, 1.45, 1.49];
            const ri = RI[n] || 1.49;
            const CR = CI / ri;

            return { ratio: CR, isConsistent: CR < 0.1, lambdaMax, CI };
        }

        function pwCalculateTripleInconsistency(scores, i, j, k) {
            const getScore = (a, b) => {
                if (a === b) return 1;
                const key1 = `${Math.min(a, b)}-${Math.max(a, b)}`;
                const score = scores[key1];
                if (score === undefined) return 1;
                const ahp = pwConvertToAHP(score);
                return a < b ? ahp : 1 / ahp;
            };
            const aij = getScore(i, j);
            const ajk = getScore(j, k);
            const aik = getScore(i, k);
            const expected = aij * ajk;
            return Math.abs(Math.log(aik / expected));
        }

        function pwFindInconsistentPairs() {
            const validOptions = pwGetValidOptions();
            const scores = pwGetAggregateScores();
            const pairs = pwGetPairs();
            const n = validOptions.length;
            if (n < 3 || Object.keys(scores).length < pairs.length) return [];

            const pairInconsistencies = [];
            pairs.forEach(([i, j]) => {
                let totalInconsistency = 0;
                let count = 0;
                for (let k = 0; k < n; k++) {
                    if (k !== i && k !== j) {
                        totalInconsistency += pwCalculateTripleInconsistency(scores, i, j, k);
                        count++;
                    }
                }
                const avgInconsistency = count > 0 ? totalInconsistency / count : 0;
                pairInconsistencies.push({
                    pair: [i, j],
                    inconsistency: avgInconsistency,
                    optionA: validOptions[i],
                    optionB: validOptions[j],
                    score: scores[`${i}-${j}`] || 0
                });
            });

            return pairInconsistencies.sort((a, b) => b.inconsistency - a.inconsistency);
        }

        // --- CSV functions ---

        function pwHandleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const text = e.target.result;
                    const lines = text.split('\n').map(line => line.trim()).filter(line => line);
                    const firstLine = lines[0].toLowerCase();
                    if (firstLine.includes('team') || firstLine.includes('member')) {
                        pwParseTeamCSV(lines);
                    } else {
                        pwParseOptionsCSV(lines);
                    }
                } catch (error) {
                    showToast('Error parsing CSV: ' + error.message, 'error');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        function pwParseOptionsCSV(lines) {
            const newOptions = [];
            for (const line of lines) {
                const trimmed = line.replace(/^"|"$/g, '').trim();
                if (trimmed && !trimmed.toLowerCase().includes('option')) {
                    newOptions.push(trimmed);
                }
            }
            if (newOptions.length < 2) { showToast('Please provide at least 2 options', 'error'); return; }
            if (newOptions.length > 10) { showToast('Maximum 10 options allowed', 'error'); return; }
            pwState.options = newOptions;
            pwState.mode = 'personal';
            showToast('Loaded ' + newOptions.length + ' options');
            pwRender();
        }

        function pwParseTeamCSV(lines) {
            let teamLine = '';
            let optionsStartIdx = -1;
            for (let i = 0; i < lines.length; i++) {
                if (lines[i].toLowerCase().includes('team')) {
                    teamLine = lines[i];
                    optionsStartIdx = i + 1;
                    break;
                }
            }
            if (!teamLine || optionsStartIdx === -1) {
                showToast('CSV format not recognized', 'error');
                return;
            }
            const colonIndex = teamLine.indexOf(':');
            const teamPart = colonIndex >= 0 ? teamLine.substring(colonIndex + 1) : teamLine;
            const memberNames = teamPart.split(',')
                .map(name => name.trim().replace(/^["']|["']$/g, ''))
                .filter(name => name && !name.toLowerCase().includes('team'));
            if (memberNames.length === 0) { showToast('No team members found', 'error'); return; }

            const newOptions = [];
            for (let i = optionsStartIdx; i < lines.length; i++) {
                const trimmed = lines[i].replace(/^["']|["']$/g, '').trim();
                if (trimmed && !trimmed.toLowerCase().includes('option')) {
                    newOptions.push(trimmed);
                }
            }
            if (newOptions.length < 2) { showToast('Please provide at least 2 options', 'error'); return; }
            if (newOptions.length > 10) { showToast('Maximum 10 options allowed', 'error'); return; }

            pwState.options = newOptions;
            pwState.mode = 'team';
            pwState.teamMembers = memberNames.map(name => ({ name, scores: {} }));
            showToast('Loaded ' + memberNames.length + ' members and ' + newOptions.length + ' options');
            pwRender();
        }

        function pwDownloadTemplate() {
            const csv = 'CSV Format Options:\n\nOPTION 1 - Simple Options List:\nOption1\nOption2\nOption3\nOption4\n\nOPTION 2 - Team + Options:\nTeam: Alice, Bob, Charlie\nOption1\nOption2\nOption3\nOption4';
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'pairwise-template.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        function pwExportCSV() {
            const validOptions = pwGetValidOptions();
            const results = pwCalculateResults();
            const consistency = pwCalculateConsistency();
            const inconsistentPairs = pwFindInconsistentPairs();
            const pairs = pwGetPairs();
            const aggregateScores = pwGetAggregateScores();

            let csv = '';
            csv += 'Pairwise Analysis Results\n';
            csv += 'Mode,' + (pwState.mode === 'team' ? 'Team' : 'Personal') + '\n';
            csv += 'Date,' + new Date().toLocaleDateString() + '\n';
            csv += 'Consistency Ratio,' + (consistency.ratio * 100).toFixed(2) + '%\n';
            csv += 'Consistency Status,' + (consistency.isConsistent ? 'Consistent' : 'Inconsistent') + '\n\n';

            csv += 'Overall Rankings\nRank,Option,Score\n';
            results.forEach((r, i) => { csv += (i + 1) + ',"' + r.option + '",' + r.score + '\n'; });
            csv += '\n';

            if (inconsistentPairs.length > 0) {
                csv += 'Pair Consistency Analysis\nOption A,Option B,Score,Inconsistency Level,Category\n';
                inconsistentPairs.forEach(item => {
                    const category = item.inconsistency > 0.5 ? 'High' : item.inconsistency > 0.3 ? 'Moderate' : 'Low';
                    csv += '"' + item.optionA + '","' + item.optionB + '",' + item.score + ',' + item.inconsistency.toFixed(3) + ',' + category + '\n';
                });
                csv += '\n';
            }

            if (pwState.mode === 'team') {
                csv += 'Individual Team Member Rankings\n';
                pwState.teamMembers.forEach(member => {
                    const memberTotals = {};
                    validOptions.forEach(opt => { memberTotals[opt] = 0; });
                    Object.entries(member.scores).forEach(([key, score]) => {
                        const [i, j] = key.split('-').map(Number);
                        memberTotals[validOptions[i]] += score;
                        memberTotals[validOptions[j]] -= score;
                    });
                    const memberResults = Object.entries(memberTotals)
                        .map(([option, score]) => ({ option, score }))
                        .sort((a, b) => b.score - a.score);
                    csv += '\n' + member.name + '\nRank,Option,Score\n';
                    memberResults.forEach((r, i) => { csv += (i + 1) + ',"' + r.option + '",' + r.score + '\n'; });
                });
                csv += '\n';
            }

            csv += 'Pairwise Comparisons\n';
            if (pwState.mode === 'team') {
                csv += 'Option A,Option B,' + pwState.teamMembers.map(m => m.name).join(',') + ',Average\n';
                pairs.forEach(([i, j]) => {
                    const key = i + '-' + j;
                    csv += '"' + validOptions[i] + '","' + validOptions[j] + '",';
                    csv += pwState.teamMembers.map(m => m.scores[key] || 0).join(',');
                    csv += ',' + (aggregateScores[key] || 0) + '\n';
                });
            } else {
                csv += 'Option A,Option B,Score\n';
                pairs.forEach(([i, j]) => {
                    const key = i + '-' + j;
                    csv += '"' + validOptions[i] + '","' + validOptions[j] + '",' + (pwState.teamMembers[0].scores[key] || 0) + '\n';
                });
            }

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'pairwise-analysis-' + new Date().toISOString().split('T')[0] + '.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        // --- Render functions ---

        function pwRenderSetup() {
            const validOptions = pwGetValidOptions();
            const pairs = pwGetPairs();
            const totalComparisons = pwState.mode === 'team' ? pairs.length * pwState.teamMembers.length : pairs.length;

            let html = '<div class="form-section">';

            // Analysis name
            html += '<div class="pw-field">';
            html += '<label>Analysis Name</label>';
            html += '<input type="text" value="' + pwState.analysisName.replace(/"/g, '&quot;') + '" oninput="pwState.analysisName = this.value" placeholder="e.g. Q1 Priority Ranking">';
            html += '</div>';

            // CSV upload box
            html += '<div class="pw-info-box">';
            html += '<h3>Quick Setup via CSV</h3>';
            html += '<p style="margin-bottom: 10px;">Upload a CSV file with your options and team members</p>';
            html += '<input type="file" id="pwCsvUpload" accept=".csv" onchange="pwHandleFileUpload(event)" style="display:none">';
            html += '<div style="display:flex; gap:8px;">';
            html += '<button class="btn btn-secondary btn-small" onclick="document.getElementById(\'pwCsvUpload\').click()">Upload CSV</button>';
            html += '<button class="btn btn-small" onclick="pwDownloadTemplate()">Download Template</button>';
            html += '</div></div>';

            html += '<div class="pw-divider">-- OR --</div>';

            // Mode selection
            html += '<div class="pw-field"><label>Analysis Mode</label></div>';
            html += '<div class="pw-mode-grid">';
            html += '<div class="pw-mode-btn' + (pwState.mode === 'personal' ? ' selected' : '') + '" onclick="pwState.mode=\'personal\'; pwRender();">';
            html += '<div class="pw-mode-title">Personal</div><div class="pw-mode-desc">Individual analysis</div></div>';
            html += '<div class="pw-mode-btn' + (pwState.mode === 'team' ? ' selected' : '') + '" onclick="pwState.mode=\'team\'; pwRender();">';
            html += '<div class="pw-mode-title">Team</div><div class="pw-mode-desc">Aggregate team input</div></div>';
            html += '</div>';

            // Team members (if team mode)
            if (pwState.mode === 'team') {
                html += '<div class="pw-field"><label>Team Members</label></div>';
                pwState.teamMembers.forEach((member, i) => {
                    html += '<div class="pw-field-row">';
                    html += '<input type="text" value="' + member.name.replace(/"/g, '&quot;') + '" oninput="pwState.teamMembers[' + i + '].name = this.value" placeholder="Team member ' + (i + 1) + ' name">';
                    if (pwState.teamMembers.length > 1) {
                        html += '<button class="btn btn-danger btn-small" onclick="pwState.teamMembers.splice(' + i + ', 1); if(pwState.currentMember >= pwState.teamMembers.length) pwState.currentMember = Math.max(0, pwState.teamMembers.length - 1); pwRender();">Remove</button>';
                    }
                    html += '</div>';
                });
                html += '<button class="btn btn-small" style="margin-top:8px;" onclick="pwState.teamMembers.push({ name: \'\', scores: {} }); pwRender();">+ Add Team Member</button>';
                html += '<div style="margin-bottom:20px;"></div>';
            }

            // Options
            html += '<div class="pw-field"><label>Options to Compare</label></div>';
            pwState.options.forEach((opt, i) => {
                html += '<div class="pw-field-row">';
                html += '<input type="text" value="' + opt.replace(/"/g, '&quot;') + '" oninput="pwState.options[' + i + '] = this.value" placeholder="Option ' + (i + 1) + '">';
                if (pwState.options.length > 2) {
                    html += '<button class="btn btn-danger btn-small" onclick="pwState.options.splice(' + i + ', 1); pwRender();">Remove</button>';
                }
                html += '</div>';
            });
            if (pwState.options.length < 10) {
                html += '<button class="btn btn-small" style="margin-top:8px;" onclick="pwState.options.push(\'\'); pwRender();">+ Add Option</button>';
            }

            // Start button
            html += '<div style="margin-top:20px;">';
            html += '<button class="btn btn-primary" onclick="pwStartAnalysis()"' + (validOptions.length < 2 ? ' disabled' : '') + ' style="width:100%;">';
            html += 'Start Analysis (' + validOptions.length + ' options, ' + totalComparisons + ' comparisons)';
            html += '</button></div>';

            html += '</div>';
            return html;
        }

        function pwRenderCompare() {
            const validOptions = pwGetValidOptions();
            const pairs = pwGetPairs();
            const [i, j] = pairs[pwState.currentPair];
            const totalComparisons = pwState.mode === 'team' ? pairs.length * pwState.teamMembers.length : pairs.length;
            const completedComparisons = pwState.currentMember * pairs.length + pwState.currentPair;
            const progress = totalComparisons > 0 ? ((completedComparisons / totalComparisons) * 100).toFixed(0) : 0;

            let html = '<div class="form-section">';

            // Progress
            html += '<div style="display:flex; justify-content:space-between; font-size:0.85rem; color:var(--muted); margin-bottom:6px;">';
            if (pwState.mode === 'team') {
                html += '<span>' + pwState.teamMembers[pwState.currentMember].name + ' - Comparison ' + (pwState.currentPair + 1) + ' of ' + pairs.length + '</span>';
            } else {
                html += '<span>Comparison ' + (pwState.currentPair + 1) + ' of ' + pairs.length + '</span>';
            }
            html += '<span>' + progress + '% complete</span>';
            html += '</div>';
            html += '<div class="pw-progress-bar"><div class="pw-progress-fill" style="width:' + progress + '%"></div></div>';

            // Team member badges
            if (pwState.mode === 'team') {
                html += '<div class="pw-member-badges">';
                pwState.teamMembers.forEach((member, idx) => {
                    const cls = idx === pwState.currentMember ? 'current' : idx < pwState.currentMember ? 'done' : 'pending';
                    html += '<span class="pw-member-badge ' + cls + '">' + member.name + '</span>';
                });
                html += '</div>';
            }

            // Compare heading
            html += '<h3 style="text-align:center; margin:20px 0; color:var(--text);">Compare these options</h3>';

            // Option cards
            html += '<div class="pw-compare-grid">';
            html += '<div class="pw-option-card a"><h3>Option A</h3><p>' + validOptions[i] + '</p></div>';
            html += '<div class="pw-option-card b"><h3>Option B</h3><p>' + validOptions[j] + '</p></div>';
            html += '</div>';

            // Score buttons
            html += '<div class="pw-score-section">';
            html += '<div class="pw-score-label">How much do you prefer Option A over Option B?</div>';
            html += '<div class="pw-score-hints"><span>Strongly prefer B</span><span>Neutral</span><span>Strongly prefer A</span></div>';
            html += '<div class="pw-score-grid">';
            [-5, -4, -3, -2, -1, 0, 1, 2, 3, 4, 5].forEach(score => {
                const cls = score < 0 ? 'negative' : score > 0 ? 'positive' : 'neutral';
                html += '<button class="pw-score-btn ' + cls + '" onclick="pwHandleScore(' + score + ')">' + (score > 0 ? '+' : '') + score + '</button>';
            });
            html += '</div></div>';

            html += '<p class="pw-score-hint">-5 = Strongly prefer B | 0 = Neutral/Equal | +5 = Strongly prefer A</p>';
            html += '</div>';
            return html;
        }

        function pwRenderResults() {
            const validOptions = pwGetValidOptions();
            const results = pwCalculateResults();
            const consistency = pwCalculateConsistency();
            const inconsistentPairs = pwFindInconsistentPairs();

            // Render chart after DOM update
            setTimeout(() => {
                const ctx = document.getElementById('pwResultsChart');
                if (ctx) {
                    if (pwChartInstance) pwChartInstance.destroy();
                    pwChartInstance = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: results.map(r => r.option),
                            datasets: [{
                                label: 'Score',
                                data: results.map(r => r.score),
                                backgroundColor: results.map(r => r.score >= 0 ? '#7CC170' : '#e94560')
                            }]
                        },
                        options: {
                            indexAxis: 'y',
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: false } }
                        }
                    });
                }
            }, 100);

            let html = '<div class="form-section">';

            // Consistency check
            html += '<div class="pw-consistency ' + (consistency.isConsistent ? 'good' : 'warn') + '">';
            html += '<h3>AHP Consistency Check</h3>';
            html += '<p>Consistency Ratio: <strong>' + (consistency.ratio * 100).toFixed(1) + '%</strong>';
            html += consistency.isConsistent ? ' — Your comparisons are consistent' : ' — Comparisons show inconsistency (threshold: 10%)';
            html += '</p>';
            if (!consistency.isConsistent) {
                html += '<p style="font-size:0.8rem; color:var(--muted); margin-top:6px;">Review the inconsistent pairs below to improve consistency.</p>';
            }
            html += '</div>';

            // Inconsistent pairs
            if (inconsistentPairs.length > 0) {
                html += '<div class="pw-section"><h3>Pair Consistency Rankings</h3>';
                html += '<p style="font-size:0.85rem; color:var(--muted); margin-bottom:12px;">Pairs ranked by inconsistency (highest first):</p>';
                inconsistentPairs.slice(0, 5).forEach(item => {
                    const level = item.inconsistency > 0.5 ? 'high' : item.inconsistency > 0.3 ? 'moderate' : 'low';
                    html += '<div class="pw-inconsistent-item ' + level + '">';
                    html += '<div><strong>' + item.optionA + ' vs ' + item.optionB + '</strong>';
                    html += ' <span style="font-size:0.85rem; color:var(--muted);">(Score: ' + (item.score > 0 ? '+' : '') + item.score + ')</span></div>';
                    html += '<div style="text-align:right;"><div style="font-weight:600;">' + item.inconsistency.toFixed(3) + '</div>';
                    html += '<div style="font-size:0.75rem; color:var(--muted);">' + (item.inconsistency > 0.5 ? 'High' : item.inconsistency > 0.3 ? 'Moderate' : 'Low') + '</div></div>';
                    html += '</div>';
                });
                html += '</div>';
            }

            // Chart
            html += '<div class="pw-section"><h3>Overall Rankings</h3>';
            html += '<div class="pw-chart-container"><canvas id="pwResultsChart"></canvas></div>';
            html += '</div>';

            // Detailed rankings
            html += '<div class="pw-section"><h3>Detailed Rankings</h3>';
            results.forEach((result, index) => {
                html += '<div class="pw-result-row">';
                html += '<div class="pw-rank-circle">' + (index + 1) + '</div>';
                html += '<div class="pw-result-name">' + result.option + '<div class="pw-weight">Weight: ' + (result.normalizedWeight * 100).toFixed(1) + '%</div></div>';
                html += '<div class="pw-result-score"><div class="pw-score-value ' + (result.score >= 0 ? 'positive' : 'negative') + '">' + (result.score > 0 ? '+' : '') + result.score + '</div><div class="pw-score-label">raw score</div></div>';
                html += '<div class="pw-result-normalized"><div class="pw-norm-value">' + result.normalizedWeight.toFixed(3) + '</div><div class="pw-norm-label">normalized</div></div>';
                html += '</div>';
            });
            html += '</div>';

            // Team member rankings
            if (pwState.mode === 'team') {
                html += '<div class="pw-section"><h3>Individual Team Member Rankings</h3>';
                html += '<div class="pw-team-grid">';
                pwState.teamMembers.forEach(member => {
                    const memberTotals = {};
                    validOptions.forEach(opt => { memberTotals[opt] = 0; });
                    Object.entries(member.scores).forEach(([key, score]) => {
                        const [i, j] = key.split('-').map(Number);
                        memberTotals[validOptions[i]] += score;
                        memberTotals[validOptions[j]] -= score;
                    });
                    const memberResults = Object.entries(memberTotals)
                        .map(([option, score]) => ({ option, score }))
                        .sort((a, b) => b.score - a.score);

                    html += '<div class="pw-team-card"><h4>' + member.name + '</h4>';
                    memberResults.forEach((r, i) => {
                        html += '<div class="pw-team-rank"><span>' + (i + 1) + '. ' + r.option + '</span>';
                        html += '<span style="font-weight:600; color:' + (r.score >= 0 ? 'var(--pmo-green)' : '#e94560') + ';">' + (r.score > 0 ? '+' : '') + r.score + '</span></div>';
                    });
                    html += '</div>';
                });
                html += '</div></div>';
            }

            // Action buttons
            html += '<div class="pw-actions">';
            html += '<button class="btn" onclick="pwHandleReset()">New Analysis</button>';
            html += '<button class="btn btn-secondary" onclick="pwCopyResults()">Copy Results</button>';
            html += '<button class="btn btn-secondary" onclick="pwExportCSV()">Export CSV</button>';
            html += '<button class="btn btn-primary" onclick="pwSaveAnalysis()">Save Analysis</button>';
            html += '</div>';

            html += '</div>';
            return html;
        }

        function pwRender() {
            const app = document.getElementById('pwApp');
            if (!app) return;
            if (pwState.step === 'setup') {
                app.innerHTML = pwRenderSetup();
            } else if (pwState.step === 'compare') {
                app.innerHTML = pwRenderCompare();
            } else if (pwState.step === 'results') {
                app.innerHTML = pwRenderResults();
            }
        }

        // --- Action functions ---

        function pwStartAnalysis() {
            const validOptions = pwGetValidOptions();
            if (validOptions.length < 2) {
                showToast('Please provide at least 2 options', 'error');
                return;
            }
            if (pwState.mode === 'team' && pwState.teamMembers.some(m => !m.name.trim())) {
                showToast('Please name all team members', 'error');
                return;
            }
            pwState.step = 'compare';
            pwState.currentPair = 0;
            pwState.currentMember = 0;
            // Reset scores for fresh analysis
            pwState.teamMembers.forEach(m => { m.scores = {}; });
            pwState.analysisId = null;
            pwRender();
        }

        function pwHandleScore(score) {
            const pairs = pwGetPairs();
            const [i, j] = pairs[pwState.currentPair];
            const key = i + '-' + j;
            pwState.teamMembers[pwState.currentMember].scores[key] = score;

            if (pwState.currentPair < pairs.length - 1) {
                pwState.currentPair++;
            } else if (pwState.mode === 'team' && pwState.currentMember < pwState.teamMembers.length - 1) {
                pwState.currentMember++;
                pwState.currentPair = 0;
            } else {
                pwState.step = 'results';
            }
            pwRender();
        }

        function pwHandleReset() {
            pwState.step = 'setup';
            pwState.mode = 'personal';
            pwState.options = ['', '', '', '', ''];
            pwState.currentPair = 0;
            pwState.teamMembers = [{ name: '', scores: {} }];
            pwState.currentMember = 0;
            pwState.analysisName = '';
            pwState.analysisId = null;
            if (pwChartInstance) { pwChartInstance.destroy(); pwChartInstance = null; }
            pwRender();
        }

        function pwCopyResults() {
            const results = pwCalculateResults();
            const consistency = pwCalculateConsistency();
            const text = [
                'Pairwise Analysis Results',
                'Consistency Ratio: ' + (consistency.ratio * 100).toFixed(1) + '% ' + (consistency.isConsistent ? '(Consistent)' : '(Inconsistent)'),
                '',
                'Rankings:',
                ...results.map((r, i) => (i + 1) + '. ' + r.option + ': Score ' + r.score + ', Weight ' + (r.normalizedWeight * 100).toFixed(1) + '% (' + r.normalizedWeight.toFixed(3) + ')'),
                '',
                'Normalized Weights (sum to 1.0):',
                ...results.map(r => '  ' + r.option + ': ' + r.normalizedWeight.toFixed(4))
            ].join('\n');

            navigator.clipboard.writeText(text).then(() => {
                showToast('Results copied to clipboard!');
            });
        }

        // --- Firebase persistence ---

        async function pwSaveAnalysis() {
            if (!firebaseReady || !pwAnalysesRef) {
                showToast('Firebase not ready', 'error');
                return;
            }
            const name = pwState.analysisName.trim() || 'Untitled Analysis';
            const validOptions = pwGetValidOptions();
            const results = pwCalculateResults();
            const consistency = pwCalculateConsistency();

            const analysis = {
                name: name,
                mode: pwState.mode,
                options: validOptions,
                teamMembers: pwState.teamMembers,
                results: {
                    rankings: results,
                    consistencyRatio: consistency.ratio,
                    isConsistent: consistency.isConsistent
                },
                updatedAt: new Date().toISOString()
            };

            try {
                if (pwState.analysisId) {
                    await pwAnalysesRef.child(pwState.analysisId).update(analysis);
                } else {
                    analysis.createdAt = new Date().toISOString();
                    const newRef = pwAnalysesRef.push();
                    pwState.analysisId = newRef.key;
                    await newRef.set(analysis);
                }
                showToast('Analysis saved!');
                pwLoadAnalyses();
            } catch (e) {
                console.error('Save error:', e);
                showToast('Error saving analysis', 'error');
            }
        }

        async function pwLoadAnalyses() {
            if (!firebaseReady || !pwAnalysesRef) return;
            try {
                const snapshot = await pwAnalysesRef.orderByChild('updatedAt').once('value');
                const select = document.getElementById('pwSavedSelect');
                if (!select) return;

                select.innerHTML = '<option value="">-- Saved Analyses --</option>';
                const data = snapshot.val();
                if (!data) return;

                Object.entries(data).reverse().forEach(([key, analysis]) => {
                    const opt = document.createElement('option');
                    opt.value = key;
                    opt.textContent = analysis.name + ' (' + new Date(analysis.updatedAt).toLocaleDateString() + ')';
                    select.appendChild(opt);
                });
            } catch (e) {
                console.error('Load analyses error:', e);
            }
        }

        async function pwLoadSaved() {
            const select = document.getElementById('pwSavedSelect');
            const key = select ? select.value : '';
            if (!key || !pwAnalysesRef) { showToast('Select an analysis first', 'error'); return; }

            try {
                const snapshot = await pwAnalysesRef.child(key).once('value');
                const data = snapshot.val();
                if (!data) { showToast('Analysis not found', 'error'); return; }

                pwState.analysisId = key;
                pwState.analysisName = data.name || '';
                pwState.mode = data.mode || 'personal';
                pwState.options = data.options || ['', '', '', '', ''];
                pwState.teamMembers = data.teamMembers || [{ name: '', scores: {} }];
                pwState.step = 'results';
                pwState.currentPair = 0;
                pwState.currentMember = 0;
                pwRender();
                showToast('Loaded: ' + data.name);
            } catch (e) {
                console.error('Load saved error:', e);
                showToast('Error loading analysis', 'error');
            }
        }

        async function pwDeleteSaved() {
            const select = document.getElementById('pwSavedSelect');
            const key = select ? select.value : '';
            if (!key || !pwAnalysesRef) { showToast('Select an analysis first', 'error'); return; }
            if (!confirm('Delete this saved analysis?')) return;

            try {
                await pwAnalysesRef.child(key).remove();
                showToast('Analysis deleted');
                pwLoadAnalyses();
                if (pwState.analysisId === key) {
                    pwState.analysisId = null;
                    pwHandleReset();
                }
            } catch (e) {
                console.error('Delete error:', e);
                showToast('Error deleting analysis', 'error');
            }
        }

        // Pairwise global exports
        window.pwStartAnalysis = pwStartAnalysis;
        window.pwHandleScore = pwHandleScore;
        window.pwHandleReset = pwHandleReset;
        window.pwCopyResults = pwCopyResults;
        window.pwExportCSV = pwExportCSV;
        window.pwDownloadTemplate = pwDownloadTemplate;
        window.pwHandleFileUpload = pwHandleFileUpload;
        window.pwSaveAnalysis = pwSaveAnalysis;
        window.pwLoadSaved = pwLoadSaved;
        window.pwDeleteSaved = pwDeleteSaved;
        window.pwRender = pwRender;

        // ==========================================
        // INITIAL LOAD
        // ==========================================
        // Auth state is handled by onAuthStateChanged listener above.
        // No manual init needed — Firebase Auth persists sessions automatically.
    </script>
</body>
</html>
